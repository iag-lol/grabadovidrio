<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GrabaVidrios Enterprise - Sistema de Gestión de Flota</title>
  
  <!-- Estilos y Librerías -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Librerías JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/es.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.40.0/apexcharts.min.js"></script>

  <style>
:root {
      /* Colores principales */
      --primary: #0b63e5;
      --primary-light: #3b82f6;
      --primary-dark: #0747a6;
      --primary-hover: #0d57c8;
      --primary-gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      
      /* Colores secundarios */
      --secondary: #0f172a;
      --secondary-light: #1e293b;
      --secondary-dark: #0a101b;
      
      /* Colores de acento */
      --accent: #7c3aed;
      --accent-light: #a78bfa;
      
      /* Colores de estado */
      --success: #10b981;
      --success-light: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --warning-light: rgba(245, 158, 11, 0.1);
      --danger: #ef4444;
      --danger-light: rgba(239, 68, 68, 0.1);
      --info: #0ea5e9;
      --info-light: rgba(14, 165, 233, 0.1);
      --pending: #f97316;
      --pending-light: rgba(249, 115, 22, 0.1);
      
      /* Colores de fondo */
      --light: #f8fafc;
      --light-dark: #f1f5f9;
      --dark: #0f172a;
      --surface: #ffffff;
      --surface-2: #f1f5f9;
      --surface-3: #e2e8f0;
      
      /* Colores de texto */
      --text: #334155;
      --text-light: #64748b;
      --text-lighter: #94a3b8;
      --text-dark: #1e293b;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
      --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
      
      /* Bordes */
      --border: #e2e8f0;
      --border-dark: #cbd5e1;
      
      /* Radios */
      --radius-sm: 0.25rem;
      --radius: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      
      /* Transiciones */
      --transition-fast: 0.15s ease;
      --transition: 0.2s ease;
      --transition-slow: 0.3s ease;
      
      /* Animaciones */
      --cubic-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--light);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      min-height: 100vh;
    }
    
    /* Scroll personalizado */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--secondary-light);
      border-radius: var(--radius-xl);
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    /* Layout Base */
    .layout {
      display: flex;
      width: 100%;
      min-height: 100vh;
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
    }

    /* Añadimos animación de carga para solucionar el problema de pegado */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Mejorar el pre-loader */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--light);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    
    #loader .spinner {
      width: 50px;
      height: 50px;
      position: relative;
    }
    
    #loader .spinner:before,
    #loader .spinner:after {
      content: "";
      position: absolute;
      border-radius: 50%;
    }
    
    #loader .spinner:before {
      width: 100%;
      height: 100%;
      background-color: rgba(59, 130, 246, 0.2);
      animation: pulse 1.5s ease infinite alternate;
    }
    
    #loader .spinner:after {
      width: 70%;
      height: 70%;
      background-color: var(--primary);
      top: 15%;
      left: 15%;
      animation: pulse 1.5s ease-out infinite alternate-reverse;
    }
    
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #loader .loader-text {
      margin-top: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      letter-spacing: -0.02em;
    }

    /* Sidebar mejorado */
    .sidebar {
      position: fixed;
      width: 280px;
      height: 100vh;
      background: linear-gradient(to bottom, var(--secondary) 0%, var(--secondary-dark) 100%);
      color: white;
      z-index: 50;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
      transition: all 0.3s var(--cubic-bounce);
    }

    .sidebar.collapsed {
      width: 80px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sidebar-logo {
      height: 40px;
      width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      color: var(--primary-light);
      font-size: 1.25rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s var(--cubic-bounce);
    }
    
    .sidebar-logo:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.15);
    }

    .sidebar-logo::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(59, 130, 246, 0.4), transparent);
      top: 0;
      left: 0;
    }

    .sidebar-title {
      display: flex;
      flex-direction: column;
    }

    .sidebar-title strong {
      font-weight: 700;
      font-size: 1.2rem;
      color: white;
    }

    .sidebar-title span {
      font-size: 0.7rem;
      color: var(--primary-light);
      opacity: 0.8;
    }

    .sidebar-toggle {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transition: var(--transition);
    }

    .sidebar-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(180deg);
    }

    .sidebar.collapsed .sidebar-title,
    .sidebar.collapsed .sidebar-toggle {
      display: none;
    }

    .nav-menu {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 0.5rem;
    }

    .nav-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--primary-light);
      margin: 1.5rem 0.75rem 0.75rem;
      opacity: 0.8;
    }

    .sidebar.collapsed .nav-section-title {
      display: none;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.85rem 1.2rem;
      margin: 0.3rem 0;
      border-radius: var(--radius);
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }

    .nav-item:hover {
      color: white;
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .nav-item.active {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 0 20px rgba(11, 99, 229, 0.5);
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: white;
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .nav-icon {
      width: 22px;
      text-align: center;
      margin-right: 12px;
      font-size: 1.1rem;
    }

    .sidebar.collapsed .nav-text {
      display: none;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 0.85rem;
    }

    .sidebar.collapsed .nav-icon {
      margin-right: 0;
    }

    .sidebar-footer {
      padding: 1rem;
      font-size: 0.7rem;
      color: var(--text-lighter);
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar.collapsed .sidebar-footer {
      display: none;
    }

    /* Área de contenido principal */
    .main-content {
      flex: 1;
      margin-left: 280px;
      transition: margin-left 0.3s var(--cubic-bounce);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-content.expanded {
      margin-left: 80px;
    }

    /* Header */
    .header {
      background-color: var(--surface);
      box-shadow: var(--shadow);
      height: 70px;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .header-content {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Contenedor de página */
    .page-container {
      padding: 2rem;
      flex: 1;
    }

    /* Páginas */
    .page {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .page.active {
      display: block;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      display: flex;
      align-items: center;
      transition: transform 0.3s var(--cubic-bounce), box-shadow 0.3s var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }
    
    /* Añadimos un efecto de brillo al hover */
    .stat-card:before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 80%);
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    
    .stat-card:hover:before {
      opacity: 0.8;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }

    .stat-card.primary::after { background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); }
    .stat-card.success::after { background: linear-gradient(90deg, var(--success) 0%, #20d997 100%); }
    .stat-card.warning::after { background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%); }
    .stat-card.danger::after { background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%); }
    .stat-card.info::after { background: linear-gradient(90deg, var(--info) 0%, #38bdf8 100%); }
    .stat-card.pending::after { background: linear-gradient(90deg, var(--pending) 0%, #fb923c 100%); }

    .stat-icon {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      margin-right: 1.25rem;
      font-size: 1.5rem;
      flex-shrink: 0;
      transition: transform 0.3s var(--cubic-bounce);
    }
    
    .stat-card:hover .stat-icon {
      transform: scale(1.1);
    }

    .stat-icon.primary { 
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(59, 130, 246, 0.5);
    }
    
    .stat-icon.success { 
      background: linear-gradient(135deg, var(--success) 0%, #0d9668 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(16, 185, 129, 0.5);
    }
    
    .stat-icon.warning { 
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(245, 158, 11, 0.5);
    }
    
    .stat-icon.danger { 
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(239, 68, 68, 0.5);
    }
    
    .stat-icon.info { 
      background: linear-gradient(135deg, var(--info) 0%, #0284c7 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(14, 165, 233, 0.5);
    }
    
    .stat-icon.pending { 
      background: linear-gradient(135deg, var(--pending) 0%, #ea580c 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(249, 115, 22, 0.5);
    }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-dark);
      display: flex;
      align-items: baseline;
    }

    .stat-value .trend {
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }

    .trend.positive { color: var(--success); }
    .trend.negative { color: var(--danger); }

    /* Grid layouts */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .col-span-2 {
      grid-column: span 2;
    }

    .col-span-3 {
      grid-column: span 3;
    }

    .col-span-4 {
      grid-column: span 4;
    }

    .row-span-2 {
      grid-row: span 2;
    }

    /* Card Component */
    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
      height: 100%;
      transition: transform 0.3s var(--cubic-bounce), box-shadow 0.3s var(--transition);
      border: 1px solid var(--border);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-3px);
      border-color: var(--border-dark);
    }

    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(5px);
    }

    .card-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-title i {
      color: var(--primary);
    }

    .card-tools {
      display: flex;
      gap: 0.5rem;
    }

    .card-body {
      padding: 1.5rem;
    }

    .card-body-chart {
      padding: 1rem 0.5rem;
    }

    .card-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--surface-2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Componente de tabla */
    .data-table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      background-color: white;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .data-table-container:hover {
      box-shadow: var(--shadow);
      border-color: var(--border-dark);
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
    }

    .data-table th {
      background-color: var(--surface-2);
      text-align: left;
      padding: 1rem;
      font-weight: 600;
      color: var(--text-dark);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      transition: background-color 0.2s ease;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background-color: var(--surface-2);
    }

    .data-table-empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    /* Badges de estado */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      gap: 0.35rem;
      line-height: 1;
      transition: all 0.2s ease;
    }
    
    .badge:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .badge-success {
      background-color: var(--success-light);
      color: var(--success);
    }

    .badge-warning {
      background-color: var(--warning-light);
      color: var(--warning);
    }

    .badge-primary {
      background-color: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .badge-info {
      background-color: var(--info-light);
      color: var(--info);
    }

    .badge-danger {
      background-color: var(--danger-light);
      color: var(--danger);
    }

    .badge-pending {
      background-color: var(--pending-light);
      color: var(--pending);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s var(--cubic-bounce);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }
    
    .btn:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.4);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    .btn:active:after {
      animation: ripple 0.6s ease-out;
    }
    
    @keyframes ripple {
      0% { opacity: 1; transform: scale(0, 0); }
      20% { opacity: 1; transform: scale(25, 25); }
      100% { opacity: 0; transform: scale(40, 40); }
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(11, 99, 229, 0.5);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 15px -5px rgba(11, 99, 229, 0.3);
    }

    .btn-secondary {
      background-color: var(--surface-3);
      color: var(--text);
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: var(--border);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #0d9668 100%);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(16, 185, 129, 0.5);
    }

    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #0ca975 0%, var(--success) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 15px -5px rgba(16, 185, 129, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(239, 68, 68, 0.5);
    }

    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #e02424 0%, var(--danger) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 15px -5px rgba(239, 68, 68, 0.3);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .btn-lg {
      padding: 1rem 2rem;
      font-size: 1rem;
    }

    .btn-action {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: var(--radius);
      font-size: 1rem;
    }

    /* Action buttons */
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      background-color: var(--surface-2);
      color: var(--text);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.4);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    .action-btn:active:after {
      animation: ripple 0.6s ease-out;
    }

    .action-btn:hover {
      background-color: var(--surface-3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .action-btn.primary {
      background-color: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .action-btn.primary:hover {
      background-color: var(--primary);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(11, 99, 229, 0.5);
    }

    .action-btn.success {
      background-color: var(--success-light);
      color: var(--success);
    }

    .action-btn.success:hover {
      background-color: var(--success);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(16, 185, 129, 0.5);
    }

    .action-btn.warning {
      background-color: var(--warning-light);
      color: var(--warning);
    }

    .action-btn.warning:hover {
      background-color: var(--warning);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(245, 158, 11, 0.5);
    }

    .action-btn.danger {
      background-color: var(--danger-light);
      color: var(--danger);
    }

    .action-btn.danger:hover {
      background-color: var(--danger);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(239, 68, 68, 0.5);
    }

    .action-btn.info {
      background-color: var(--info-light);
      color: var(--info);
    }

    .action-btn.info:hover {
      background-color: var(--info);
      color: white;
      box-shadow: 0 4px 12px -4px rgba(14, 165, 233, 0.5);
    }

    /* Form components */
    .form-section {
      max-width: 900px;
      margin: 0 auto;
    }

    .form-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
      padding: 2rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .form-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-dark);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-dark);
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      color: var(--text);
      background-color: var(--surface);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-control:disabled, 
    .form-control[readonly] {
      background-color: var(--surface-2);
      cursor: not-allowed;
    }

    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1.25rem;
      padding-right: 2.5rem;
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    /* Vidrios Selector */
    .vidrios-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .vidrio-card {
      background-color: var(--surface-2);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .vidrio-card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .vidrio-card:hover:before {
      opacity: 1;
    }

    .vidrio-card:has(input:checked) {
      border-color: var(--primary);
      background-color: rgba(59, 130, 246, 0.05);
      box-shadow: 0 0 0 1px var(--primary);
    }

    .vidrio-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .vidrio-checkbox {
      position: relative;
      width: 22px;
      height: 22px;
      margin-right: 0.75rem;
      cursor: pointer;
    }

    .vidrio-checkbox input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }

    .checkmark {
      position: absolute;
      top: 0;
      left: 0;
      height: 22px;
      width: 22px;
      background-color: white;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }

    .vidrio-checkbox:hover input ~ .checkmark {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .vidrio-checkbox input:checked ~ .checkmark {
      background-color: var(--primary);
      border-color: var(--primary);
      transform: scale(1.05);
    }

    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
    }

    .vidrio-checkbox input:checked ~ .checkmark:after {
      display: block;
      animation: checkmark 0.2s var(--cubic-bounce) forwards;
    }
    
    @keyframes checkmark {
      0% { transform: scale(0); }
      100% { transform: scale(1) rotate(45deg); }
    }

    .vidrio-checkbox .checkmark:after {
      left: 7px;
      top: 3px;
      width: 6px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .vidrio-label {
      font-weight: 500;
      color: var(--text-dark);
    }

    .vidrio-upload {
      margin-top: 1rem;
      display: none;
    }

    .vidrio-card:has(input:checked) .vidrio-upload {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .upload-btn {
      display: flex;
      align-items: center;
      background-color: var(--surface);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      width: 100%;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .upload-btn:hover {
      border-color: var(--primary);
      background-color: rgba(59, 130, 246, 0.05);
      transform: translateY(-2px);
    }

    .upload-btn i {
      margin-right: 0.5rem;
      color: var(--primary);
    }

    .upload-btn span {
      font-size: 0.875rem;
      color: var(--text);
    }

    .file-info {
      display: flex;
      align-items: center;
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .file-info i {
      margin-right: 0.35rem;
      color: var(--text-light);
    }

    /* Vehicle Cards */
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .vehicle-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s var(--cubic-bounce);
      cursor: pointer;
      position: relative;
      border: 1px solid var(--border);
    }

    .vehicle-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: var(--border-dark);
    }
    
    /* Añadimos efecto de brillo */
    .vehicle-card:before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 80%);
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      z-index: 1;
    }
    
    .vehicle-card:hover:before {
      opacity: 0.8;
    }

    .vehicle-card-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .vehicle-card-ppu {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text-dark);
    }

    .vehicle-card-body {
      padding: 1.25rem;
      position: relative;
      z-index: 2;
    }

    .vehicle-card-info {
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      color: var(--text-light);
      display: flex;
      align-items: center;
    }

    .vehicle-card-info i {
      width: 18px;
      margin-right: 0.5rem;
      color: var(--primary);
    }

    .vehicle-card-stats {
      display: flex;
      gap: 1rem;
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border);
    }

    .vehicle-card-stat {
      flex: 1;
      text-align: center;
    }

    .vehicle-card-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .vehicle-card-stat-label {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    .vehicle-card::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 6px;
    }

    .vehicle-card.completed::before {
      background: linear-gradient(90deg, var(--success) 0%, rgba(16, 185, 129, 0.5) 100%);
    }

    .vehicle-card.pending::before {
      background: linear-gradient(90deg, var(--warning) 0%, rgba(245, 158, 11, 0.5) 100%);
    }

    .vehicle-card.none::before {
      background: linear-gradient(90deg, var(--text-lighter) 0%, rgba(148, 163, 184, 0.5) 100%);
    }

    /* Modal Components */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-container {
      background-color: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid var(--border);
    }

    .modal-overlay.active .modal-container {
      transform: scale(1);
      opacity: 1;
    }

    .modal-container.modal-lg {
      max-width: 900px;
    }

    .modal-container.modal-xl {
      max-width: 1200px;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(5px);
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--text-dark);
    }

    .modal-subtitle {
      font-size: 0.875rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    .modal-close {
      background: transparent;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background-color: var(--surface-3);
      color: var(--text-dark);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      background-color: var(--surface-2);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
    }


    /* Vehicle Viewer */
    .vehicle-viewer {
      display: flex;
      gap: 1.5rem;
      height: 100%;
    }

    .vehicle-viewer-sidebar {
      width: 300px !important;
      flex-shrink: 0 !important;
      border-right: 1px solid var(--border) !important;
      padding-right: 1.5rem !important;
      padding-left: 1rem !important; 
      margin-left: 1rem !important;
      position: relative;
    }
    
    .vehicle-viewer-sidebar:after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 1px;
      height: 100%;
      background: linear-gradient(180deg, 
        rgba(226, 232, 240, 0) 0%,
        rgba(226, 232, 240, 1) 50%,
        rgba(226, 232, 240, 0) 100%
      );
    }

    .vehicle-viewer-header {
      margin-bottom: 1.5rem;
    }

    .vehicle-viewer-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .vehicle-viewer-subtitle {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    .vehicle-viewer-info {
      background-color: var(--surface-2);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .vehicle-viewer-info:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--border-dark);
    }

    .vehicle-viewer-stat {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .vehicle-viewer-stat:last-child {
      margin-bottom: 0;
    }

    .vehicle-viewer-stat i {
      width: 20px;
      margin-right: 0.75rem;
      color: var(--primary);
    }

    .vehicle-viewer-stat-label {
      font-size: 0.85rem;
      color: var(--text-light);
      flex: 1;
    }

    .vehicle-viewer-stat-value {
      font-weight: 600;
      color: var(--text-dark);
    }

    .vehicle-viewer-timeline {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .vehicle-viewer-content {
      flex: 1;
      overflow-y: auto;
    }

    .vehicle-viewer-detail {
      background-color: var(--surface-2) !important;
      border-radius: var(--radius-lg) !important;
      padding: 1.5rem !important;
      margin: 0 1rem 1.5rem 1rem !important;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .vehicle-viewer-detail:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--border-dark);
    }

    .vehicle-viewer-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .vehicle-viewer-detail-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-dark);
    }

    .vehicle-viewer-detail-date {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .vehicle-viewer-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .vehicle-viewer-gallery-item {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      aspect-ratio: 4/3;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      border: 2px solid transparent;
      transition: all 0.3s var(--cubic-bounce);
    }
    
    .vehicle-viewer-gallery-item:hover {
      transform: scale(1.03) translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-light);
      z-index: 1;
    }

    .vehicle-viewer-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .vehicle-viewer-gallery-item:hover img {
      transform: scale(1.05);
    }

    .vehicle-viewer-gallery-item-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 0.5rem;
      background: linear-gradient(0deg, rgba(15, 23, 42, 0.8), transparent);
      color: white;
      font-size: 0.75rem;
      text-align: center;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .vehicle-viewer-gallery-item:hover .vehicle-viewer-gallery-item-caption {
      transform: translateY(0);
    }

    /* Timeline Component */
    .timeline {
      position: relative;
    }

    .timeline::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 18px;
      width: 2px;
      background: linear-gradient(180deg, 
        rgba(226, 232, 240, 0) 0%, 
        var(--border) 10%,
        var(--border) 90%,
        rgba(226, 232, 240, 0) 100%
      );
    }

    .timeline-item {
      position: relative;
      padding-left: 50px;
      padding-bottom: 1.5rem;
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-item.active .timeline-content {
      border-color: var(--primary);
      background-color: rgba(59, 130, 246, 0.05);
      box-shadow: 0 0 0 1px var(--primary), var(--shadow-sm);
      transform: translateX(5px);
    }

    .timeline-badge {
      position: absolute;
      top: 0;
      left: 0;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-color: var(--surface);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      font-size: 1rem;
      transition: all 0.3s var(--cubic-bounce);
    }
    
    .timeline-item:hover .timeline-badge {
      transform: scale(1.1);
    }

    .timeline-badge.primary { 
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white; 
      border-color: var(--primary);
      box-shadow: 0 4px 12px -4px rgba(11, 99, 229, 0.5);
    }
    
    .timeline-badge.success { 
      background: linear-gradient(135deg, var(--success) 0%, #0d9668 100%);
      color: white; 
      border-color: var(--success);
      box-shadow: 0 4px 12px -4px rgba(16, 185, 129, 0.5);
    }
    
    .timeline-badge.warning { 
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white; 
      border-color: var(--warning);
      box-shadow: 0 4px 12px -4px rgba(245, 158, 11, 0.5);
    }
    
    .timeline-badge.danger { 
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white; 
      border-color: var(--danger);
      box-shadow: 0 4px 12px -4px rgba(239, 68, 68, 0.5);
    }
    
    .timeline-badge.info { 
      background: linear-gradient(135deg, var(--info) 0%, #0284c7 100%);
      color: white; 
      border-color: var(--info);
      box-shadow: 0 4px 12px -4px rgba(14, 165, 233, 0.5);
    }
    
    .timeline-badge.pending { 
      background: linear-gradient(135deg, var(--pending) 0%, #ea580c 100%);
      color: white; 
      border-color: var(--pending);
      box-shadow: 0 4px 12px -4px rgba(249, 115, 22, 0.5);
    }

    .timeline-content {
      background-color: var(--surface);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .timeline-content:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow-sm);
      transform: translateX(2px);
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-dark);
    }

    .timeline-date {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .timeline-body {
      font-size: 0.85rem;
      color: var(--text);
    }

    /* Reports Section */
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .report-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: all 0.3s var(--cubic-bounce);
      cursor: pointer;
      border: 1px solid var(--border);
      position: relative;
    }

    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: var(--border-dark);
    }
    
    /* Añadimos efecto de brillo */
    .report-card:before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 80%);
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      z-index: 1;
    }
    
    .report-card:hover:before {
      opacity: 0.8;
    }

    .report-card-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 2;
    }

    .report-card-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .report-card-title i {
      color: var(--primary);
    }

    .report-card-body {
      padding: 1.25rem;
      position: relative;
      z-index: 2;
    }

    .report-card-stat {
      display: flex;
      align-items: baseline;
      margin-bottom: 1rem;
    }

    .report-card-stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .report-card-stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-left: 0.5rem;
    }

    /* Filter Card */
    .filter-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .filter-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-dark);
    }

    .filter-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-title i {
      color: var(--primary);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    .filter-group {
      margin-bottom: 1rem;
    }

    .filter-label {
      display: block;
      margin-bottom: 0.35rem;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .filter-control {
      width: 100%;
      padding: 0.6rem 0.85rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      color: var(--text);
      background-color: var(--surface);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-xs);
    }

    .filter-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    select.filter-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    /* Loader Component mejorado */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(248, 250, 252, 0.75);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    .loader-text {
      margin-top: 1rem;
      font-weight: 500;
      color: var(--text-dark);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast Component */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 9998;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-width: 350px;
    }

    .toast {
      display: flex;
      align-items: flex-start;
      background-color: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 1rem;
      transform: translateX(120%);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      position: relative;
      border: 1px solid var(--border);
    }

    .toast.active {
      transform: translateX(0);
      opacity: 1;
    }

    .toast::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
    }

    .toast.success::before { background: linear-gradient(180deg, var(--success) 0%, #0d9668 100%); }
    .toast.warning::before { background: linear-gradient(180deg, var(--warning) 0%, #d97706 100%); }
    .toast.error::before { background: linear-gradient(180deg, var(--danger) 0%, #dc2626 100%); }
    .toast.info::before { background: linear-gradient(180deg, var(--info) 0%, #0284c7 100%); }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }

    .toast-icon.success { 
      background: linear-gradient(135deg, var(--success) 0%, #0d9668 100%);
      color: white; 
      box-shadow: 0 4px 12px -4px rgba(16, 185, 129, 0.5);
    }
    
    .toast-icon.warning { 
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white; 
      box-shadow: 0 4px 12px -4px rgba(245, 158, 11, 0.5);
    }
    
    .toast-icon.error { 
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white; 
      box-shadow: 0 4px 12px -4px rgba(239, 68, 68, 0.5);
    }
    
    .toast-icon.info { 
      background: linear-gradient(135deg, var(--info) 0%, #0284c7 100%);
      color: white; 
      box-shadow: 0 4px 12px -4px rgba(14, 165, 233, 0.5);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-dark);
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background-color: var(--border);
      width: 100%;
    }

    .toast-progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
      animation: progress 4s linear forwards;
    }

    @keyframes progress {
      0% { width: 100%; }
      100% { width: 0%; }
    }

    /* Quality Evaluation Component */
    .evaluation-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .evaluation-card:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--border-dark);
    }

    .evaluation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .evaluation-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-dark);
    }

    .evaluation-criteria {
      margin-bottom: 1rem;
    }

    .evaluation-criterion {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .evaluation-criterion-label {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text);
    }

    .evaluation-rating {
      display: flex;
      gap: 0.35rem;
    }

    .rating-option {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
      color: var(--text-light);
      background-color: var(--surface);
    }

    .rating-option:hover {
      border-color: var(--primary-light);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .rating-option.selected {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-color: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px -4px rgba(37, 99, 235, 0.5);
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Script para solucionar el problema de carga inicial */
    #page-preloader {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--light);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    
    #page-preloader .preloader-logo {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      position: relative;
    }
    
    #page-preloader .preloader-logo-icon {
      font-size: 2.5rem;
      color: var(--primary);
      position: relative;
      z-index: 2;
      animation: pulse 1.5s infinite alternate;
    }
    
    #page-preloader .preloader-logo-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, rgba(255,255,255,0) 70%);
      border-radius: 50%;
      animation: pulse-bg 1.5s infinite alternate;
    }
    
    #page-preloader .preloader-text {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }
    
    #page-preloader .preloader-spinner {
      width: 150px;
      height: 6px;
      background-color: var(--surface-3);
      border-radius: var(--radius-full);
      overflow: hidden;
      position: relative;
    }
    
    #page-preloader .preloader-spinner:after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 30%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: var(--radius-full);
      animation: preloader-progress 1.5s infinite;
    }
    
    @keyframes pulse-bg {
      0% { transform: scale(0.9); opacity: 0.5; }
      100% { transform: scale(1.1); opacity: 0.8; }
    }
    
    @keyframes preloader-progress {
      0% { left: -30%; }
      100% { left: 100%; }
    }

    /* Responsive Design */
    @media (max-width: 1280px) {
      .vehicle-viewer {
        flex-direction: column;
      }
      
      .vehicle-viewer-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding-right: 0;
        padding-bottom: 1.5rem;
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        width: 80px;
      }
      
      .sidebar .sidebar-title, 
      .sidebar .sidebar-toggle,
      .sidebar .nav-text,
      .sidebar .nav-section-title,
      .sidebar .sidebar-footer {
        display: none;
      }
      
      .sidebar .nav-item {
        justify-content: center;
        padding: 0.85rem;
      }
      
      .sidebar .nav-icon {
        margin-right: 0;
      }
      
      .main-content {
        margin-left: 80px;
      }
      
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .col-span-2, .col-span-3, .col-span-4 {
        grid-column: span 1;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 0 1rem;
      }
      
      .page-container {
        padding: 1rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .vidrios-container {
        grid-template-columns: 1fr;
      }
      
      .filter-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-container.modal-lg, 
      .modal-container.modal-xl {
        width: 95%;
      }
    }

    @media (max-width: 576px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: fixed;
        bottom: 0;
        top: auto;
        z-index: 50;
      }
      
      .sidebar-header {
        display: none;
      }
      
      .nav-menu {
        display: flex;
        justify-content: space-around;
        padding: 0.5rem;
      }
      
      .nav-item {
        flex-direction: column;
        padding: 0.5rem;
        margin: 0;
        text-align: center;
        font-size: 0.75rem;
      }
      
      .nav-icon {
        margin-right: 0;
        margin-bottom: 0.25rem;
      }
      
      .nav-text {
        display: block;
        font-size: 0.7rem;
      }
      
      .main-content {
        margin-left: 0;
        margin-bottom: 60px;
      }
      
      .header {
        height: 60px;
      }
      
      .page-title {
        font-size: 1.25rem;
      }
    }

  </style>

</head>

<body>
  <!-- Loader Global -->
  <div id="loader" class="loader-overlay">
    <div class="spinner"></div>
    <p class="loader-text">Cargando datos...</p>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Layout Principal -->
  <div class="layout">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="sidebar-logo">
            <i class="fas fa-wind"></i>
          </div>
          <div class="sidebar-title">
            <strong>GrabaVidrios</strong>
            <span>Sistema de Gestión</span>
          </div>
        </div>
        <button id="sidebarToggle" class="sidebar-toggle">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      
      <nav class="nav-menu">
        <div class="nav-section-title">Principal</div>
        <a class="nav-item active" data-page="dashboard">
          <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
          <div class="nav-text">Dashboard</div>
        </a>
        <a class="nav-item" data-page="solicitudes">
          <div class="nav-icon"><i class="fas fa-clipboard-list"></i></div>
          <div class="nav-text">Solicitudes</div>
        </a>
        <a class="nav-item" data-page="nueva-solicitud">
          <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
          <div class="nav-text">Nueva Solicitud</div>
        </a>
        <a class="nav-item" data-page="flota">
          <div class="nav-icon"><i class="fas fa-bus"></i></div>
          <div class="nav-text">Flota</div>
        </a>
        
        <div class="nav-section-title">Reportes</div>
        <a class="nav-item" data-page="informes">
          <div class="nav-icon"><i class="fas fa-file-alt"></i></div>
          <div class="nav-text">Informes</div>
        </a>
        <a class="nav-item" data-page="estadisticas">
          <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
          <div class="nav-text">Estadísticas</div>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        <p>GrabaVidrios Enterprise v2.5</p>
      </div>
    </aside>

    <!-- Contenido Principal -->
    <main id="mainContent" class="main-content">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <h1 id="pageTitle" class="page-title">Dashboard</h1>
          <div class="header-actions">
            <button id="refreshData" class="btn btn-primary btn-sm">
              <i class="fas fa-sync-alt"></i> Actualizar Datos
            </button>
          </div>
        </div>
      </header>

      <!-- Contenedor de Página -->
      <div class="page-container">
        
        <!-- Página: Dashboard -->
        <div class="page active" id="dashboardPage">
          <div class="stats-grid">
            <div class="stat-card primary">
              <div class="stat-icon primary">
                <i class="fas fa-clipboard-list"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Total Solicitudes</div>
                <div class="stat-value" id="totalSolicitudes">0</div>
              </div>
            </div>
            
            <div class="stat-card warning">
              <div class="stat-icon warning">
                <i class="fas fa-spinner"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">En Proceso</div>
                <div class="stat-value" id="enProceso">0</div>
              </div>
            </div>
            
            <div class="stat-card success">
              <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Completados</div>
                <div class="stat-value" id="completados">0</div>
              </div>
            </div>
            
            <div class="stat-card info">
              <div class="stat-icon info">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Este Mes</div>
                <div class="stat-value" id="esteMes">0</div>
              </div>
            </div>
          </div>
          
          <div class="grid grid-3">
            <div class="card col-span-2">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-bar"></i> Solicitudes por Terminal
                </div>
                <div class="card-tools">
                  <select id="chartTimeFilter" class="filter-control">
                    <option value="all">Todo el tiempo</option>
                    <option value="month">Este mes</option>
                    <option value="quarter">Este trimestre</option>
                    <option value="year">Este año</option>
                  </select>
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="terminalChart" style="height: 350px;"></div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-pie"></i> Estado de Solicitudes
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="estadoChart" style="height: 350px;"></div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-exclamation-triangle"></i> Motivos de Cambio
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="motivosChart" style="height: 350px;"></div>
              </div>
            </div>
            
            <div class="card col-span-2">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-line"></i> Tendencia de Solicitudes
                </div>
                <div class="card-tools">
                  <button id="exportTrend" class="action-btn primary" title="Exportar Datos">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="trendChart" style="height: 350px;"></div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-clipboard-check"></i> Últimas Solicitudes
              </div>
              <a class="action-btn primary" data-page="solicitudes" title="Ver Todas">
                <i class="fas fa-arrow-right"></i>
              </a>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="data-table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>PPU</th>
                      <th>N° Interno</th>
                      <th>Terminal</th>
                      <th>Fecha</th>
                      <th>Motivo</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="ultimas-solicitudes">
                    <!-- Datos cargados por JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Página: Solicitudes -->
        <div class="page" id="solicitudesPage">
          <div class="filter-card">
            <div class="filter-title">
              <i class="fas fa-filter"></i> Filtrar Solicitudes
            </div>
            <div class="filter-grid">
              <div class="filter-group">
                <label class="filter-label">PPU / N° Interno</label>
                <input type="text" id="filterPpu" class="filter-control" placeholder="Buscar...">
              </div>
              <div class="filter-group">
                <label class="filter-label">Terminal</label>
                <select id="filterTerminal" class="filter-control">
                  <option value="">Todos</option>
                  <option value="El Roble">El Roble</option>
                  <option value="La Reina">La Reina</option>
                  <option value="Maria Angelica">Maria Angelica</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Estado</label>
                <select id="filterEstado" class="filter-control">
                  <option value="">Todos</option>
                  <option value="SOLICITUD">Solicitud</option>
                  <option value="TRABAJANDO">Trabajando</option>
                  <option value="TERMINADO">Terminado</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Motivo</label>
                <select id="filterMotivo" class="filter-control">
                  <option value="">Todos</option>
                  <option value="Choque">Choque</option>
                  <option value="Daño de Terceros">Daño de Terceros</option>
                  <option value="Desgaste">Desgaste</option>
                  <option value="Vandalismo">Vandalismo</option>
                  <option value="Error de Grabado">Error de Grabado</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Fecha Desde</label>
                <input type="date" id="filterFechaDesde" class="filter-control">
              </div>
              <div class="filter-group">
                <label class="filter-label">Fecha Hasta</label>
                <input type="date" id="filterFechaHasta" class="filter-control">
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
              <button id="resetFilters" class="btn btn-secondary btn-sm">
                <i class="fas fa-undo"></i> Limpiar Filtros
              </button>
              <button id="exportSolicitudes" class="btn btn-primary btn-sm">
                <i class="fas fa-file-export"></i> Exportar Resultados
              </button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-clipboard-list"></i> Listado de Solicitudes
              </div>
              <div id="solicitudesCount" class="badge badge-primary">0 resultados</div>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="data-table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>PPU</th>
                      <th>N° Interno</th>
                      <th>Terminal</th>
                      <th>Fecha Solicitud</th>
                      <th>Programación</th>
                      <th>Motivo</th>
                      <th>Vidrios</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="solicitudesBody">
                    <!-- Datos cargados por JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Página: Nueva Solicitud -->
        <div class="page" id="nueva-solicitudPage">
          <div class="form-section">
            <form id="nuevaSolicitudForm" class="form-card">
              <div class="form-grid">
                <div class="form-group">
                  <label for="ppuInput" class="form-label">PPU / N° Interno *</label>
                  <div style="position: relative;">
                    <input type="text" id="ppuInput" class="form-control" placeholder="Buscar por PPU o N° Interno..." required>
                    <div id="sugerenciasPpu" style="position: absolute; width: 100%; z-index: 10;"></div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="numeroInternoInput" class="form-label">N° Interno (Autocompletado)</label>
                  <input type="text" id="numeroInternoInput" class="form-control" readonly>
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="terminalInput" class="form-label">Terminal *</label>
                  <select id="terminalInput" class="form-control" required>
                    <option value="">Seleccionar Terminal</option>
                    <option value="El Roble">El Roble</option>
                    <option value="La Reina">La Reina</option>
                    <option value="Maria Angelica">Maria Angelica</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="fechaSolicitudInput" class="form-label">Fecha de Solicitud *</label>
                  <input type="date" id="fechaSolicitudInput" class="form-control" required>
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="fechaProgramacionInput" class="form-label">Fecha de Programación *</label>
                  <input type="date" id="fechaProgramacionInput" class="form-control" required>
                </div>
                
                <div class="form-group">
                  <label for="motivoInput" class="form-label">Motivo del Cambio *</label>
                  <select id="motivoInput" class="form-control" required>
                    <option value="">Seleccionar Motivo</option>
                    <option value="Choque">Choque</option>
                    <option value="Daño de Terceros">Daño de Terceros</option>
                    <option value="Desgaste">Desgaste</option>
                    <option value="Vandalismo">Vandalismo</option>
                    <option value="Error de Grabado">Error de Grabado</option>
                    <option value="Otro">Otro</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Vidrios a Grabar y Fotos *</label>
                <div class="vidrios-container" id="vidriosContainer">
                  <!-- Generado por JS -->
                </div>
                <p id="vidriosError" style="color: var(--danger); font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                  Debe seleccionar al menos un vidrio.
                </p>
              </div>
              
              <div class="form-group">
                <label for="observacionesInput" class="form-label">Observaciones</label>
                <textarea id="observacionesInput" class="form-control" placeholder="Anotaciones adicionales..."></textarea>
              </div>
              
              <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem; gap: 0.75rem;">
                <button type="button" class="btn btn-secondary" id="resetForm">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Guardar Solicitud
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Página: Flota -->
        <div class="page" id="flotaPage">
          <div class="filter-card">
            <div class="filter-title">
              <i class="fas fa-search"></i> Buscar Vehículos
            </div>
            <div class="filter-grid">
              <div class="filter-group">
                <label class="filter-label">PPU / N° Interno</label>
                <input type="text" id="buscarFlota" class="filter-control" placeholder="Buscar...">
              </div>
              <div class="filter-group">
                <label class="filter-label">Terminal</label>
                <select id="filtrarFlotaTerminal" class="filter-control">
                  <option value="">Todos</option>
                  <option value="El Roble">El Roble</option>
                  <option value="La Reina">La Reina</option>
                  <option value="Maria Angelica">Maria Angelica</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Estado</label>
                <select id="filtrarFlotaEstado" class="filter-control">
                  <option value="">Todos</option>
                  <option value="completed">Completo</option>
                  <option value="pending">Pendiente</option>
                  <option value="none">Sin Solicitudes</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="vehicle-grid" id="flotaGrid">
            <!-- Generado por JS -->
          </div>
        </div>
        
        <!-- Página: Informes -->
        <div class="page" id="informesPage">
          <div class="reports-grid">
            <div class="report-card" id="reportePendientes">
              <div class="report-card-header">
                <div class="report-card-title">
                  <i class="fas fa-clock"></i> Solicitudes Pendientes
                </div>
              </div>
              <div class="report-card-body">
                <div class="report-card-stat">
                  <div class="report-card-stat-value" id="pendientesTotal">0</div>
                  <div class="report-card-stat-label">en total</div>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <div>
                    <div class="badge badge-warning" id="pendientesBadge">
                      <i class="fas fa-spinner"></i> Pendientes
                    </div>
                  </div>
                  <button class="btn btn-primary btn-sm" onclick="generarInformePendientes()">
                    <i class="fas fa-file-export"></i> Generar
                  </button>
                </div>
              </div>
            </div>
            
            <div class="report-card" id="reporteRealizados">
              <div class="report-card-header">
                <div class="report-card-title">
                  <i class="fas fa-check-circle"></i> Solicitudes Realizadas
                </div>
              </div>
              <div class="report-card-body">
                <div class="report-card-stat">
                  <div class="report-card-stat-value" id="realizadosTotal">0</div>
                  <div class="report-card-stat-label">en total</div>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <div>
                    <div class="badge badge-success" id="realizadosBadge">
                      <i class="fas fa-check"></i> Completados
                    </div>
                  </div>
                  <button class="btn btn-primary btn-sm" onclick="generarInformeRealizados()">
                    <i class="fas fa-file-export"></i> Generar
                  </button>
                </div>
              </div>
            </div>
            
            <div class="report-card" id="reporteMensual">
              <div class="report-card-header">
                <div class="report-card-title">
                  <i class="fas fa-calendar-alt"></i> Informe Mensual
                </div>
              </div>
              <div class="report-card-body">
                <div class="report-card-stat">
                  <div class="report-card-stat-value" id="mensualTotal">0</div>
                  <div class="report-card-stat-label">este mes</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                  <div>
                    <select id="mesMensual" class="filter-control">
                      <option value="1">Enero</option>
                      <option value="2">Febrero</option>
                      <option value="3">Marzo</option>
                      <option value="4">Abril</option>
                      <option value="5">Mayo</option>
                      <option value="6">Junio</option>
                      <option value="7">Julio</option>
                      <option value="8">Agosto</option>
                      <option value="9">Septiembre</option>
                      <option value="10">Octubre</option>
                      <option value="11">Noviembre</option>
                      <option value="12">Diciembre</option>
                    </select>
                  </div>
                  <button class="btn btn-primary btn-sm" onclick="generarInformeMensual()">
                    <i class="fas fa-file-export"></i> Generar
                  </button>
                </div>
              </div>
            </div>
            
            <div class="report-card" id="reporteAnual">
              <div class="report-card-header">
                <div class="report-card-title">
                  <i class="fas fa-calendar-check"></i> Informe Anual
                </div>
              </div>
              <div class="report-card-body">
                <div class="report-card-stat">
                  <div class="report-card-stat-value" id="anualTotal">0</div>
                  <div class="report-card-stat-label">este año</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                  <div>
                    <select id="anioAnual" class="filter-control">
                      <option value="2023">2023</option>
                      <option value="2024">2024</option>
                      <option value="2025">2025</option>
                    </select>
                  </div>
                  <button class="btn btn-primary btn-sm" onclick="generarInformeAnual()">
                    <i class="fas fa-file-export"></i> Generar
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-chart-bar"></i> Evolución Anual de Solicitudes
              </div>
            </div>
            <div class="card-body card-body-chart">
              <div id="yearlyChart" style="height: 400px;"></div>
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-pie"></i> Distribución por Terminal
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="terminalDistributionChart" style="height: 300px;"></div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-pie"></i> Distribución por Motivo
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="motivoDistributionChart" style="height: 300px;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Página: Estadísticas -->
        <div class="page" id="estadisticasPage">
          <div class="stats-grid">
            <div class="stat-card primary">
              <div class="stat-icon primary">
                <i class="fas fa-tachometer-alt"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Promedio Mensual</div>
                <div class="stat-value" id="promedioMensual">0</div>
              </div>
            </div>
            
            <div class="stat-card success">
              <div class="stat-icon success">
                <i class="fas fa-percentage"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Tasa de Finalización</div>
                <div class="stat-value" id="tasaFinalizacion">0%</div>
              </div>
            </div>
            
            <div class="stat-card warning">
              <div class="stat-icon warning">
                <i class="fas fa-business-time"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Tiempo Promedio</div>
                <div class="stat-value" id="tiempoPromedio">0 días</div>
              </div>
            </div>
            
            <div class="stat-card info">
              <div class="stat-icon info">
                <i class="fas fa-trophy"></i>
              </div>
              <div class="stat-content">
                <div class="stat-label">Terminal más Activo</div>
                <div class="stat-value" id="terminalActivo">-</div>
              </div>
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-line"></i> Tendencia Anual
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="tendenciaAnualChart" style="height: 350px;"></div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-bar"></i> Comparativa Mensual
                </div>
              </div>
              <div class="card-body card-body-chart">
                <div id="comparativaMensualChart" style="height: 350px;"></div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-map-marker-alt"></i> Distribución por Terminal
              </div>
            </div>
            <div class="card-body">
              <div class="grid grid-3">
                <div id="elRobleStats" class="evaluation-card">
                  <div class="evaluation-header">
                    <div class="evaluation-title">El Roble</div>
                    <div class="badge badge-primary" id="elRobleBadge">0 solicitudes</div>
                  </div>
                  <div id="elRobleChart" style="height: 200px;"></div>
                </div>
                
                <div id="laReinaStats" class="evaluation-card">
                  <div class="evaluation-header">
                    <div class="evaluation-title">La Reina</div>
                    <div class="badge badge-primary" id="laReinaBadge">0 solicitudes</div>
                  </div>
                  <div id="laReinaChart" style="height: 200px;"></div>
                </div>
                
                <div id="mariaAngelicaStats" class="evaluation-card">
                  <div class="evaluation-header">
                    <div class="evaluation-title">Maria Angelica</div>
                    <div class="badge badge-primary" id="mariaAngelicaBadge">0 solicitudes</div>
                  </div>
                  <div id="mariaAngelicaChart" style="height: 200px;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </main>
  </div>
  
  <!-- MODALES -->
  
  <!-- Modal: Editar Solicitud -->
  <div id="editModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <div>
          <div class="modal-title">Gestionar Solicitud</div>
          <div class="modal-subtitle" id="editModalInfo"></div>
        </div>
        <button class="modal-close" onclick="closeModal('editModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editRequestId">
        
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select id="editStatusSelect" class="form-control">
            <option value="SOLICITUD">Solicitud</option>
            <option value="TRABAJANDO">Trabajando</option>
            <option value="TERMINADO">Terminado</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Fecha de Programación</label>
          <input type="date" id="editProgramacionInput" class="form-control">
        </div>
        
        <div id="evaluacionContainer" style="display: none;">
          <div class="evaluation-card">
            <div class="evaluation-header">
              <div class="evaluation-title">Evaluación de Calidad</div>
            </div>
            
            <div class="evaluation-criteria">
              <div class="evaluation-criterion">
                <div class="evaluation-criterion-label">Calidad del grabado</div>
                <div class="evaluation-rating">
                    <div class="rating-option" data-value="1">1</div>
                    <div class="rating-option" data-value="2">2</div>
                    <div class="rating-option" data-value="3">3</div>
                    <div class="rating-option" data-value="4">4</div>
                    <div class="rating-option" data-value="5">5</div>
                  </div>
                </div>
                
                <div class="evaluation-criterion">
                  <div class="evaluation-criterion-label">Precisión de ubicación</div>
                  <div class="evaluation-rating">
                    <div class="rating-option" data-value="1">1</div>
                    <div class="rating-option" data-value="2">2</div>
                    <div class="rating-option" data-value="3">3</div>
                    <div class="rating-option" data-value="4">4</div>
                    <div class="rating-option" data-value="5">5</div>
                  </div>
                </div>
                
                <div class="evaluation-criterion">
                  <div class="evaluation-criterion-label">Acabado final</div>
                  <div class="evaluation-rating">
                    <div class="rating-option" data-value="1">1</div>
                    <div class="rating-option" data-value="2">2</div>
                    <div class="rating-option" data-value="3">3</div>
                    <div class="rating-option" data-value="4">4</div>
                    <div class="rating-option" data-value="5">5</div>
                  </div>
                </div>
                
                <div class="evaluation-criterion">
                  <div class="evaluation-criterion-label">Tiempo de ejecución</div>
                  <div class="evaluation-rating">
                    <div class="rating-option" data-value="1">1</div>
                    <div class="rating-option" data-value="2">2</div>
                    <div class="rating-option" data-value="3">3</div>
                    <div class="rating-option" data-value="4">4</div>
                    <div class="rating-option" data-value="5">5</div>
                  </div>
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Observaciones de Calidad</label>
                <textarea id="evaluacionObservaciones" class="form-control" placeholder="Comentarios sobre la calidad del trabajo..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarCambiosSolicitud()">Guardar Cambios</button>
        </div>
      </div>
    </div>
  
    <!-- Modal: Historial de Vehículo -->
    <div id="historyModal" class="modal-overlay">
      <div class="modal-container modal-xl">
        <div class="modal-header">
          <div>
            <div class="modal-title">Historial de Vehículo</div>
            <div class="modal-subtitle" id="historyModalInfo"></div>
          </div>
          <button class="modal-close" onclick="closeModal('historyModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body" style="padding: 0;">
          <div class="vehicle-viewer">
            <div class="vehicle-viewer-sidebar">
              <div class="vehicle-viewer-header">
                <h2 class="vehicle-viewer-title" id="vehiclePPU"></h2>
                <p class="vehicle-viewer-subtitle" id="vehicleInfo"></p>
              </div>
              
              <div class="vehicle-viewer-info">
                <div class="vehicle-viewer-stat">
                  <i class="fas fa-hashtag"></i>
                  <div class="vehicle-viewer-stat-label">N° Interno</div>
                  <div class="vehicle-viewer-stat-value" id="vehicleInterno"></div>
                </div>
                <div class="vehicle-viewer-stat">
                  <i class="fas fa-map-marker-alt"></i>
                  <div class="vehicle-viewer-stat-label">Terminal</div>
                  <div class="vehicle-viewer-stat-value" id="vehicleTerminal"></div>
                </div>
                <div class="vehicle-viewer-stat">
                  <i class="fas fa-calendar-alt"></i>
                  <div class="vehicle-viewer-stat-label">Última Solicitud</div>
                  <div class="vehicle-viewer-stat-value" id="vehicleLastRequest"></div>
                </div>
                <div class="vehicle-viewer-stat">
                  <i class="fas fa-clipboard-list"></i>
                  <div class="vehicle-viewer-stat-label">Total Solicitudes</div>
                  <div class="vehicle-viewer-stat-value" id="vehicleTotalRequests"></div>
                </div>
              </div>
              
              <div class="vehicle-viewer-timeline" id="historyTimeline">
                <!-- Generado por JS -->
              </div>
            </div>
            
            <div class="vehicle-viewer-content" id="historyContent">
              <div id="noContentMessage" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-light); padding: 2rem;">
                <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary-light);"></i>
                <p>Selecciona una solicitud del historial para ver los detalles</p>
              </div>
              
              <!-- El contenido del historial se cargará aquí dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Modal: Vista de Imagen -->
    <div id="imageViewerModal" class="modal-overlay">
      <div class="modal-image-container">
        <button class="modal-close-btn" onclick="closeModal('imageViewerModal')">
          <i class="fas fa-times"></i>
        </button>
        
        <button class="modal-nav-btn modal-prev-btn" onclick="navigateImages('prev')">
          <i class="fas fa-chevron-left"></i>
        </button>
        
        <img id="fullSizeImage" class="modal-image">
        
        <button class="modal-nav-btn modal-next-btn" onclick="navigateImages('next')">
          <i class="fas fa-chevron-right"></i>
        </button>
        
        <div class="modal-image-title">
          <h3 id="imageTitle"></h3>
        </div>
      </div>
    </div>
    
    <style>
      .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        backdrop-filter: blur(8px) !important;
        z-index: 1000 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .modal-overlay.active {
        opacity: 1 !important;
        visibility: visible !important;
      }
      
      .modal-image-container {
        position: relative !important;
        display: inline-flex !important;
        flex-direction: column !important;
        align-items: center !important;
        background: transparent !important;
        max-height: 90vh !important;
      }
      
      .modal-image {
        max-width: 100% !important;
        max-height: 80vh !important;
        object-fit: contain !important;
        border-radius: var(--radius) !important;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4) !important;
        transition: transform 0.3s var(--cubic-bounce);
      }
      
      .modal-close-btn {
        position: absolute !important;
        top: -40px !important;
        right: -40px !important;
        width: 36px !important;
        height: 36px !important;
        border-radius: 50% !important;
        background: rgba(0, 0, 0, 0.6) !important;
        color: white !important;
        border: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        z-index: 10 !important;
        font-size: 1rem !important;
      }
      
      .modal-close-btn:hover {
        background: rgba(255, 255, 255, 0.25) !important;
        transform: rotate(90deg) !important;
      }
      
      .modal-nav-btn {
        position: absolute !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        background: rgba(0, 0, 0, 0.6) !important;
        color: white !important;
        border: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        font-size: 1rem !important;
      }
      
      .modal-prev-btn {
        left: -60px !important;
      }
      
      .modal-next-btn {
        right: -60px !important;
      }
      
      .modal-nav-btn:hover {
        background: rgba(255, 255, 255, 0.25) !important;
        transform: translateY(-50%) scale(1.1) !important;
      }
      
      .modal-image-title {
        margin-top: 1rem !important;
        color: white !important;
        text-align: center !important;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5) !important;
        max-width: 100% !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      @media (max-width: 768px) {
        .modal-close-btn {
          top: 10px !important;
          right: 10px !important;
        }
        
        .modal-nav-btn {
          width: 36px !important;
          height: 36px !important;
          background: rgba(0, 0, 0, 0.4) !important;
        }
        
        .modal-prev-btn {
          left: 10px !important;
        }
        
        .modal-next-btn {
          right: 10px !important;
        }
      }
    </style>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const imageModal = document.getElementById('imageViewerModal');
        const imageContainer = document.querySelector('.modal-image-container');
        
        if (imageModal) {
          imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
              closeModal('imageViewerModal');
            }
          });
        }
        
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && imageModal.classList.contains('active')) {
            closeModal('imageViewerModal');
          }
          
          if (imageModal.classList.contains('active')) {
            if (e.key === 'ArrowLeft') {
              navigateImages('prev');
            } else if (e.key === 'ArrowRight') {
              navigateImages('next');
            }
          }
        });
      });
      
      function navigateImages(direction) {
        const galleryItems = document.querySelectorAll('.vehicle-viewer-gallery-item img');
        if (!galleryItems || galleryItems.length === 0) return;
        
        const currentSrc = document.getElementById('fullSizeImage').src;
        let currentIndex = -1;
        
        for (let i = 0; i < galleryItems.length; i++) {
          if (galleryItems[i].src === currentSrc) {
            currentIndex = i;
            break;
          }
        }
        
        if (currentIndex === -1) return;
        
        let newIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;
        
        if (newIndex >= galleryItems.length) newIndex = 0;
        if (newIndex < 0) newIndex = galleryItems.length - 1;
        
        const newSrc = galleryItems[newIndex].src;
        const newTitle = galleryItems[newIndex].alt || '';
        
        document.getElementById('fullSizeImage').src = newSrc;
        document.getElementById('imageTitle').textContent = newTitle;
      }
    </script>
  
    <!-- Modal: Confirmación de Eliminación -->
    <div id="deleteConfirmModal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <div class="modal-title">Confirmar Eliminación</div>
          <button class="modal-close" onclick="closeModal('deleteConfirmModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="deleteRequestId">
          <p>¿Estás seguro de que deseas eliminar esta solicitud?</p>
          <p>Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">Cancelar</button>
          <button class="btn btn-danger" onclick="eliminarSolicitud()">Eliminar</button>
        </div>
      </div>
    </div>
  
    <script>
      // Configuración de Supabase
      const SUPABASE_URL = 'https://tcmtxvuucjttngcazgff.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0';
      
      // Variables globales
      let supabase = null;
      let vehicles = [];
      let requests = [];
      const VIDRIOS_DISPONIBLES = ["Parabrisas Izquierdo", "Parabrisas Derecho", "Espejo Retrovisor Izquierdo", "Espejo Retrovisor Derecho"];
      let charts = {};
      let selectedRequest = null;
      let currentRequestId = null;
      
      // Configurar moment.js en español
      moment.locale('es');
      
      // Inicialización de la aplicación
      document.addEventListener('DOMContentLoaded', async () => {
        // Configurar Event Listeners
        setupEventListeners();
        
        // Inicializar fechas actuales
        initDatePickers();
        
        // Verificar credenciales de Supabase
        if (!SUPABASE_URL || !SUPABASE_KEY) {
          hideLoader();
          showToast('Error Crítico', 'Las credenciales de Supabase no están configuradas.', 'error');
          return;
        }
        
        // Inicializar cliente de Supabase
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Cargar datos iniciales
        await loadInitialData();
        
        // Ocultar loader con animación
        hideLoader();
        
        // Animar elementos en pantalla
        animatePageLoad();
      });
      
      // Animación inicial de la página
      function animatePageLoad() {
        gsap.from('.stats-grid .stat-card', {
          y: 30,
          opacity: 0,
          duration: 0.6,
          stagger: 0.1,
          ease: "power3.out"
        });
        
        gsap.from('.card', {
          y: 30,
          opacity: 0,
          duration: 0.6,
          delay: 0.3,
          stagger: 0.1,
          ease: "power3.out"
        });
        
        // Animar contadores en dashboard
        animateStatsCounters();
      }
      
      // Animar contadores de estadísticas
      function animateStatsCounters() {
        const counters = document.querySelectorAll('.stat-value');
        
        counters.forEach(counter => {
          const value = counter.textContent;
          if (!isNaN(parseInt(value))) {
            const target = parseInt(value);
            
            gsap.fromTo(counter, 
              { textContent: 0 }, 
              {
                textContent: target,
                duration: 2,
                ease: "power2.out",
                onUpdate: function() {
                  counter.textContent = Math.round(this.targets()[0].textContent);
                }
              }
            );
          }
        });
      }
      
      // Configurar event listeners
      function setupEventListeners() {
        // Navegación
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', (e) => {
            document.querySelector('.nav-item.active')?.classList.remove('active');
            e.currentTarget.classList.add('active');
            navigateTo(e.currentTarget.dataset.page);
          });
        });
        
        // Navegación desde botones de acción
        document.querySelectorAll('[data-page]').forEach(item => {
          if (!item.classList.contains('nav-item')) {
            item.addEventListener('click', (e) => {
              const pageId = e.currentTarget.dataset.page;
              document.querySelector(`.nav-item[data-page="${pageId}"]`).click();
            });
          }
        });
        
        // Toggle del sidebar
        document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);
        
        // Formulario de nueva solicitud
        document.getElementById('ppuInput')?.addEventListener('input', handlePpuInput);
        document.getElementById('nuevaSolicitudForm')?.addEventListener('submit', guardarNuevaSolicitud);
        document.getElementById('resetForm')?.addEventListener('click', resetForm);
        
        // Filtros de solicitudes
        document.getElementById('filterPpu')?.addEventListener('input', loadSolicitudesData);
        document.getElementById('filterTerminal')?.addEventListener('change', loadSolicitudesData);
        document.getElementById('filterEstado')?.addEventListener('change', loadSolicitudesData);
        document.getElementById('filterMotivo')?.addEventListener('change', loadSolicitudesData);
        document.getElementById('filterFechaDesde')?.addEventListener('change', loadSolicitudesData);
        document.getElementById('filterFechaHasta')?.addEventListener('change', loadSolicitudesData);
        document.getElementById('resetFilters')?.addEventListener('click', resetFilters);
        
        // Filtros de flota
        document.getElementById('buscarFlota')?.addEventListener('input', loadFlotaData);
        document.getElementById('filtrarFlotaTerminal')?.addEventListener('change', loadFlotaData);
        document.getElementById('filtrarFlotaEstado')?.addEventListener('change', loadFlotaData);
        
        // Filtros de gráficos en dashboard
        document.getElementById('chartTimeFilter')?.addEventListener('change', () => {
          updateDashboard();
        });
        
        // Botón de refrescar datos
        document.getElementById('refreshData')?.addEventListener('click', async () => {
          showLoader('Actualizando datos...');
          await loadInitialData();
          hideLoader();
          showToast('Actualizado', 'Los datos han sido actualizados correctamente.', 'success');
        });
        
        // Botón de exportar solicitudes
        document.getElementById('exportSolicitudes')?.addEventListener('click', exportSolicitudesToExcel);
        
        // Selección de evaluación de calidad
        document.querySelectorAll('.rating-option').forEach(option => {
          option.addEventListener('click', function() {
            // Encontrar y desmarcar la opción previamente seleccionada en el mismo grupo
            const parent = this.parentElement;
            parent.querySelectorAll('.rating-option.selected').forEach(selected => {
              selected.classList.remove('selected');
            });
            
            // Marcar la opción seleccionada
            this.classList.add('selected');
          });
        });
        
        // Configurar filtros de informes
        const currentMonth = new Date().getMonth() + 1; // 1-12
        const currentYear = new Date().getFullYear();
        
        if (document.getElementById('mesMensual')) {
          document.getElementById('mesMensual').value = currentMonth;
          document.getElementById('mesMensual').addEventListener('change', updateReportCounts);
        }
        
        if (document.getElementById('anioAnual')) {
          document.getElementById('anioAnual').value = currentYear;
          document.getElementById('anioAnual').addEventListener('change', updateReportCounts);
        }
        
        // Renderizar checkboxes de vidrios
        renderVidriosCheckboxes();
      }
      
      // Inicializar fechas en los pickers
      function initDatePickers() {
        const today = new Date().toISOString().split('T')[0];
        
        if (document.getElementById('fechaSolicitudInput')) {
          document.getElementById('fechaSolicitudInput').value = today;
        }
        
        if (document.getElementById('fechaProgramacionInput')) {
          // Por defecto, programación para 3 días después
          const threeDaysLater = new Date();
          threeDaysLater.setDate(threeDaysLater.getDate() + 3);
          document.getElementById('fechaProgramacionInput').value = threeDaysLater.toISOString().split('T')[0];
        }
      }
      
      // Cargar datos iniciales
      async function loadInitialData() {
        try {
          const [vehiclesRes, requestsRes] = await Promise.all([
            supabase.from('vehicles').select('*').order('ppu', { ascending: true }),
            supabase.from('requests').select('*').order('fechacreacion', { ascending: false })
          ]);
          
          if (vehiclesRes.error) throw vehiclesRes.error;
          if (requestsRes.error) throw requestsRes.error;
          
          vehicles = vehiclesRes.data;
          requests = requestsRes.data;
          
          updateUI();
        } catch (error) {
          console.error("Error al cargar datos:", error);
          showToast('Error de Conexión', 'No se pudieron cargar los datos desde la base de datos.', 'error');
        }
      }
      
      // Actualizar interfaz completa
      function updateUI() {
        updateDashboard();
        loadSolicitudesData();
        loadFlotaData();
        loadLatestRequests();
        updateReportCounts();
        updateEstadisticas();
      }
      
      // Actualizar dashboard
      function updateDashboard() {
        // Filtrar por tiempo si es necesario
        const timeFilter = document.getElementById('chartTimeFilter')?.value || 'all';
        let filteredRequests = [...requests];
        
        if (timeFilter !== 'all') {
          const now = new Date();
          let startDate;
          
          switch (timeFilter) {
            case 'month':
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              break;
            case 'quarter':
              startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
              break;
            case 'year':
              startDate = new Date(now.getFullYear(), 0, 1);
              break;
          }
          
          filteredRequests = filteredRequests.filter(r => new Date(r.fechasolicitud) >= startDate);
        }
        
        // Actualizar contadores
        const totalSolicitudes = requests.length;
        const enProceso = requests.filter(r => r.estado === 'TRABAJANDO').length;
        const completados = requests.filter(r => r.estado === 'TERMINADO').length;
        
        // Calcular solicitudes de este mes
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const esteMes = requests.filter(r => new Date(r.fechasolicitud) >= firstDay).length;
        
        document.getElementById('totalSolicitudes').textContent = totalSolicitudes;
        document.getElementById('enProceso').textContent = enProceso;
        document.getElementById('completados').textContent = completados;
        document.getElementById('esteMes').textContent = esteMes;
        
        // Renderizar gráficos
        renderDashboardCharts(filteredRequests);
      }
      
      // Renderizar gráficos del dashboard
      function renderDashboardCharts(filteredRequests) {
        // 1. Gráfico de estado
        renderEstadoChart(filteredRequests);
        
        // 2. Gráfico de terminal
        renderTerminalChart(filteredRequests);
        
        // 3. Gráfico de motivos
        renderMotivosChart(filteredRequests);
        
        // 4. Gráfico de tendencia
        renderTrendChart(filteredRequests);
      }
      
      // Renderizar gráfico de estado
      function renderEstadoChart(filteredRequests) {
        if (charts.estadoChart) {
          charts.estadoChart.destroy();
        }
        
        const pendientes = filteredRequests.filter(r => r.estado === 'SOLICITUD').length;
        const enProceso = filteredRequests.filter(r => r.estado === 'TRABAJANDO').length;
        const completados = filteredRequests.filter(r => r.estado === 'TERMINADO').length;
        
        charts.estadoChart = new ApexCharts(document.getElementById('estadoChart'), {
          series: [pendientes, enProceso, completados],
          chart: {
            type: 'donut',
            height: 350,
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              },
              dynamicAnimation: {
                enabled: true,
                speed: 350
              }
            }
          },
          labels: ['Pendientes', 'En Proceso', 'Completados'],
          colors: ['#f59e0b', '#0b63e5', '#10b981'],
          plotOptions: {
            pie: {
              donut: {
                size: '65%',
                labels: {
                  show: true,
                  total: {
                    show: true,
                    label: 'Total',
                    formatter: function (w) {
                      return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                    }
                  }
                }
              }
            }
          },
          dataLabels: {
            enabled: true,
            formatter: function (val, opts) {
              return opts.w.globals.seriesTotals[opts.seriesIndex];
            }
          },
          legend: {
            position: 'bottom',
            fontFamily: 'Inter, sans-serif'
          },
          tooltip: {
            enabled: true,
            y: {
              formatter: function(value) {
                return value + ' solicitudes';
              }
            }
          },
          responsive: [{
            breakpoint: 480,
            options: {
              chart: {
                height: 300
              },
              legend: {
                position: 'bottom'
              }
            }
          }]
        });
        
        charts.estadoChart.render();
      }
      
      // Renderizar gráfico de terminal
      function renderTerminalChart(filteredRequests) {
        if (charts.terminalChart) {
          charts.terminalChart.destroy();
        }
        
        const terminalData = filteredRequests.reduce((acc, req) => {
          acc[req.terminal] = (acc[req.terminal] || 0) + 1;
          return acc;
        }, {});
        
        const series = [{
          name: 'Solicitudes',
          data: Object.values(terminalData)
        }];
        
        charts.terminalChart = new ApexCharts(document.getElementById('terminalChart'), {
          series: series,
          chart: {
            type: 'bar',
            height: 350,
            toolbar: {
              show: true,
              tools: {
                download: true,
                selection: false,
                zoom: false,
                zoomin: false,
                zoomout: false,
                pan: false,
                reset: false
              }
            },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              dynamicAnimation: {
                enabled: true,
                speed: 350
              }
            }
          },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: '55%',
              endingShape: 'rounded',
              borderRadius: 4
            },
          },
          dataLabels: {
            enabled: false
          },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
          },
          xaxis: {
            categories: Object.keys(terminalData),
            labels: {
              style: {
                colors: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
              }
            }
          },
          yaxis: {
            title: {
              text: 'Solicitudes',
              style: {
                color: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
                fontWeight: 500
              }
            },
            labels: {
              style: {
                colors: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
              },
              formatter: function (value) {
                return Math.round(value);
              }
            }
          },
          fill: {
            opacity: 1,
            colors: ['#0b63e5']
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return val + " solicitudes";
              }
            }
          }
        });
        
        charts.terminalChart.render();
      }
      
      // Renderizar gráfico de motivos
      function renderMotivosChart(filteredRequests) {
        if (charts.motivosChart) {
          charts.motivosChart.destroy();
        }
        
        const motivosData = filteredRequests.reduce((acc, req) => {
          if (req.motivo) {
            acc[req.motivo] = (acc[req.motivo] || 0) + 1;
          }
          return acc;
        }, {});
        
        const colors = {
          'Choque': '#ef4444',
          'Daño de Terceros': '#f97316',
          'Desgaste': '#0ea5e9',
          'Vandalismo': '#8b5cf6',
          'Error de Grabado': '#ec4899',
          'Otro': '#64748b'
        };
        
        charts.motivosChart = new ApexCharts(document.getElementById('motivosChart'), {
          series: Object.values(motivosData),
          chart: {
            type: 'pie',
            height: 350,
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              },
              dynamicAnimation: {
                enabled: true,
                speed: 350
              }
            }
          },
          labels: Object.keys(motivosData),
          colors: Object.keys(motivosData).map(key => colors[key] || '#64748b'),
          legend: {
            position: 'bottom',
            fontFamily: 'Inter, sans-serif'
          },
          dataLabels: {
            enabled: true,
            formatter: function (val, opts) {
              return opts.w.globals.seriesTotals[opts.seriesIndex];
            }
          },
          tooltip: {
            y: {
              formatter: function(value) {
                return value + ' solicitudes';
              }
            }
          },
          responsive: [{
            breakpoint: 480,
            options: {
              chart: {
                height: 300
              },
              legend: {
                position: 'bottom'
              }
            }
          }]
        });
        
        charts.motivosChart.render();
      }
      
      // Renderizar gráfico de tendencia
      function renderTrendChart(filteredRequests) {
        if (charts.trendChart) {
          charts.trendChart.destroy();
        }
        
        // Agrupar por mes
        const trendData = filteredRequests.reduce((acc, req) => {
          const date = new Date(req.fechasolicitud);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!acc[monthYear]) {
            acc[monthYear] = {
              total: 0,
              SOLICITUD: 0,
              TRABAJANDO: 0,
              TERMINADO: 0
            };
          }
          
          acc[monthYear].total += 1;
          acc[monthYear][req.estado] = (acc[monthYear][req.estado] || 0) + 1;
          
          return acc;
        }, {});
        
        // Ordenar por fecha
        const sortedMonths = Object.keys(trendData).sort();
        
        // Formatear para el gráfico
        const formattedMonths = sortedMonths.map(month => {
          const [year, monthNum] = month.split('-');
          return `${monthNum}/${year}`;
        });
        
        const series = [
          {
            name: 'Total',
            data: sortedMonths.map(month => trendData[month].total)
          },
          {
            name: 'Pendientes',
            data: sortedMonths.map(month => trendData[month].SOLICITUD || 0)
          },
          {
            name: 'En Proceso',
            data: sortedMonths.map(month => trendData[month].TRABAJANDO || 0)
          },
          {
            name: 'Completados',
            data: sortedMonths.map(month => trendData[month].TERMINADO || 0)
          }
        ];
        
        charts.trendChart = new ApexCharts(document.getElementById('trendChart'), {
          series: series,
          chart: {
            height: 350,
            type: 'line',
            dropShadow: {
              enabled: true,
              color: '#000',
              top: 18,
              left: 7,
              blur: 10,
              opacity: 0.1
            },
            toolbar: {
              show: true,
              tools: {
                download: true,
                selection: false,
                zoom: false,
                zoomin: false,
                zoomout: false,
                pan: false,
                reset: false
              }
            },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              dynamicAnimation: {
                enabled: true,
                speed: 350
              }
            }
          },
          colors: ['#0b63e5', '#f59e0b', '#8b5cf6', '#10b981'],
          dataLabels: {
            enabled: false,
          },
          stroke: {
            curve: 'smooth',
            width: [4, 3, 3, 3]
          },
          grid: {
            borderColor: '#e2e8f0',
            row: {
              colors: ['#f8fafc', 'transparent'],
              opacity: 0.5
            },
          },
          markers: {
            size: 1
          },
          xaxis: {
            categories: formattedMonths,
            labels: {
              style: {
                colors: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
              }
            }
          },
          yaxis: {
            title: {
              text: 'Solicitudes',
              style: {
                color: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
                fontWeight: 500
              }
            },
            labels: {
              style: {
                colors: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
              },
              formatter: function (value) {
                return Math.round(value);
              }
            }
          },
          legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5
          },
          tooltip: {
            y: {
              formatter: function(value) {
                return value + ' solicitudes';
              }
            }
          }
        });
        
        charts.trendChart.render();
      }
      
      // Cargar últimas solicitudes
      function loadLatestRequests() {
        const tbody = document.getElementById('ultimas-solicitudes');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (requests.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="data-table-empty">No hay solicitudes registradas.</td></tr>`;
          return;
        }
        
        // Mostrar las 5 más recientes
        const latestRequests = requests.slice(0, 5);
        
        latestRequests.forEach(req => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="font-medium">${req.ppu}</td>
            <td>${req.numerointerno || '-'}</td>
            <td>${req.terminal || '-'}</td>
            <td>${formatDate(req.fechasolicitud)}</td>
            <td>${req.motivo || '-'}</td>
            <td><span class="badge ${getStatusBadgeClass(req.estado)}"><i class="${getStatusIcon(req.estado)}"></i> ${req.estado}</span></td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="abrirModalEditar(${req.id})" class="action-btn primary" title="Gestionar Solicitud">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="mostrarHistorialVehiculo('${req.ppu}')" class="action-btn info" title="Ver Historial">
                  <i class="fas fa-history"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      // Cargar datos de solicitudes con filtros
      function loadSolicitudesData() {
        const tbody = document.getElementById('solicitudesBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (requests.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" class="data-table-empty">No hay solicitudes registradas.</td></tr>`;
          document.getElementById('solicitudesCount').textContent = '0 resultados';
          return;
        }
        
        // Aplicar filtros
        let filteredRequests = [...requests];
        
        const filterPpu = document.getElementById('filterPpu')?.value.toUpperCase() || '';
        const filterTerminal = document.getElementById('filterTerminal')?.value || '';
        const filterEstado = document.getElementById('filterEstado')?.value || '';
        const filterMotivo = document.getElementById('filterMotivo')?.value || '';
        const filterFechaDesde = document.getElementById('filterFechaDesde')?.value || '';
        const filterFechaHasta = document.getElementById('filterFechaHasta')?.value || '';
        
        if (filterPpu) {
          filteredRequests = filteredRequests.filter(req => 
            (req.ppu && req.ppu.includes(filterPpu)) || 
            (req.numerointerno && req.numerointerno.includes(filterPpu))
          );
        }
        
        if (filterTerminal) {
          filteredRequests = filteredRequests.filter(req => req.terminal === filterTerminal);
        }
        
        if (filterEstado) {
          filteredRequests = filteredRequests.filter(req => req.estado === filterEstado);
        }
        
        if (filterMotivo) {
          filteredRequests = filteredRequests.filter(req => req.motivo === filterMotivo);
        }
        
        if (filterFechaDesde) {
          filteredRequests = filteredRequests.filter(req => req.fechasolicitud >= filterFechaDesde);
        }
        
        if (filterFechaHasta) {
          filteredRequests = filteredRequests.filter(req => req.fechasolicitud <= filterFechaHasta);
        }
        
        // Actualizar contador de resultados
        document.getElementById('solicitudesCount').textContent = `${filteredRequests.length} resultado${filteredRequests.length !== 1 ? 's' : ''}`;
        
        if (filteredRequests.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" class="data-table-empty">No se encontraron solicitudes con los filtros seleccionados.</td></tr>`;
          return;
        }
        
        filteredRequests.forEach(req => {
          const tr = document.createElement('tr');
          
          // Formatear la lista de vidrios
          const vidrios = req.vidrios ? req.vidrios.join(', ') : '-';
          
          tr.innerHTML = `
            <td class="font-medium">${req.ppu}</td>
            <td>${req.numerointerno || '-'}</td>
            <td>${req.terminal || '-'}</td>
            <td>${formatDate(req.fechasolicitud)}</td>
            <td>${req.fechaprogramacion ? formatDate(req.fechaprogramacion) : '-'}</td>
            <td>${req.motivo || '-'}</td>
            <td>${vidrios}</td>
            <td><span class="badge ${getStatusBadgeClass(req.estado)}"><i class="${getStatusIcon(req.estado)}"></i> ${req.estado}</span></td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="abrirModalEditar(${req.id})" class="action-btn primary" title="Gestionar Solicitud">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="mostrarHistorialVehiculo('${req.ppu}')" class="action-btn info" title="Ver Historial">
                  <i class="fas fa-history"></i>
                </button>
                <button onclick="confirmarEliminarSolicitud(${req.id})" class="action-btn danger" title="Eliminar Solicitud">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      // Cargar datos de flota
      function loadFlotaData() {
        const grid = document.getElementById('flotaGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        if (vehicles.length === 0) {
          grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 3rem 0; color: var(--text-light);">No hay vehículos registrados.</div>`;
          return;
        }
        
        // Aplicar filtros
        let filteredVehicles = [...vehicles];
        
        const buscarFlota = document.getElementById('buscarFlota')?.value.toUpperCase() || '';
        const filtrarFlotaTerminal = document.getElementById('filtrarFlotaTerminal')?.value || '';
        const filtrarFlotaEstado = document.getElementById('filtrarFlotaEstado')?.value || '';
        
        if (buscarFlota) {
          filteredVehicles = filteredVehicles.filter(v => 
            (v.ppu && v.ppu.includes(buscarFlota)) || 
            (v.interno && v.interno.includes(buscarFlota))
          );
        }
        
        if (filtrarFlotaTerminal) {
          filteredVehicles = filteredVehicles.filter(v => v.terminal === filtrarFlotaTerminal);
        }
        
        if (filtrarFlotaEstado) {
          filteredVehicles = filteredVehicles.filter(v => {
            const status = getVehicleStatus(v.ppu);
            return status.class === filtrarFlotaEstado;
          });
        }
        
        if (filteredVehicles.length === 0) {
          grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 3rem 0; color: var(--text-light);">No se encontraron vehículos con los filtros seleccionados.</div>`;
          return;
        }
        
        filteredVehicles.forEach(v => {
          const status = getVehicleStatus(v.ppu);
          const vehicleRequests = requests.filter(r => r.ppu === v.ppu);
          const pendientes = vehicleRequests.filter(r => r.estado !== 'TERMINADO').length;
          const completados = vehicleRequests.filter(r => r.estado === 'TERMINADO').length;
          const ultimaSolicitud = vehicleRequests.length > 0 ? formatDate(vehicleRequests[0].fechasolicitud) : 'Ninguna';
          
          const card = document.createElement('div');
          card.className = `vehicle-card ${status.class}`;
          card.onclick = () => mostrarHistorialVehiculo(v.ppu);
          
          card.innerHTML = `
            <div class="vehicle-card-header">
              <div class="vehicle-card-ppu">${v.ppu}</div>
              <span class="badge ${status.badgeClass}"><i class="${status.icon}"></i> ${status.text}</span>
            </div>
            <div class="vehicle-card-body">
              <div class="vehicle-card-info">
                <i class="fas fa-hashtag"></i>
                <span>N° Interno: ${v.interno}</span>
              </div>
              <div class="vehicle-card-info">
                <i class="fas fa-map-marker-alt"></i>
                <span>Terminal: ${v.terminal}</span>
              </div>
              <div class="vehicle-card-info">
                <i class="fas fa-calendar-alt"></i>
                <span>Última solicitud: ${ultimaSolicitud}</span>
              </div>
              <div class="vehicle-card-stats">
                <div class="vehicle-card-stat">
                  <div class="vehicle-card-stat-value">${vehicleRequests.length}</div>
                  <div class="vehicle-card-stat-label">Total</div>
                </div>
                <div class="vehicle-card-stat">
                  <div class="vehicle-card-stat-value">${pendientes}</div>
                  <div class="vehicle-card-stat-label">Pendientes</div>
                </div>
                <div class="vehicle-card-stat">
                  <div class="vehicle-card-stat-value">${completados}</div>
                  <div class="vehicle-card-stat-label">Completados</div>
                </div>
              </div>
            </div>
          `;
          
          grid.appendChild(card);
        });
      }
      
      // Actualizar contadores para informes
      function updateReportCounts() {
        // Pendientes
        const pendientesTotal = requests.filter(r => r.estado !== 'TERMINADO').length;
        if (document.getElementById('pendientesTotal')) {
          document.getElementById('pendientesTotal').textContent = pendientesTotal;
        }
        if (document.getElementById('pendientesBadge')) {
          document.getElementById('pendientesBadge').textContent = `${pendientesTotal} pendientes`;
        }
        
        // Realizados
        const realizadosTotal = requests.filter(r => r.estado === 'TERMINADO').length;
        if (document.getElementById('realizadosTotal')) {
          document.getElementById('realizadosTotal').textContent = realizadosTotal;
        }
        if (document.getElementById('realizadosBadge')) {
          document.getElementById('realizadosBadge').textContent = `${realizadosTotal} completados`;
        }
        
        // Mensuales
        const selectedMonth = parseInt(document.getElementById('mesMensual')?.value || new Date().getMonth() + 1);
        const currentYear = new Date().getFullYear();
        const mensualTotal = requests.filter(r => {
          const date = new Date(r.fechasolicitud);
          return date.getMonth() + 1 === selectedMonth && date.getFullYear() === currentYear;
        }).length;
        
        if (document.getElementById('mensualTotal')) {
          document.getElementById('mensualTotal').textContent = mensualTotal;
        }
        
        // Anuales
        const selectedYear = parseInt(document.getElementById('anioAnual')?.value || new Date().getFullYear());
        const anualTotal = requests.filter(r => {
          const date = new Date(r.fechasolicitud);
          return date.getFullYear() === selectedYear;
        }).length;
        
        if (document.getElementById('anualTotal')) {
          document.getElementById('anualTotal').textContent = anualTotal;
        }
        
        // Renderizar gráficos de informes
        renderReportCharts();
      }
      
      // Renderizar gráficos para informes
      function renderReportCharts() {
        // Gráfico anual
        renderYearlyChart();
        
        // Distribuciones
        renderDistributionCharts();
      }
      
      // Renderizar gráfico anual
      function renderYearlyChart() {
        if (!document.getElementById('yearlyChart')) return;
        
        if (charts.yearlyChart) {
          charts.yearlyChart.destroy();
        }
        
        // Obtener años únicos
        const years = [...new Set(requests.map(r => new Date(r.fechasolicitud).getFullYear()))].sort();
        
        // Para cada año, obtener datos mensuales
        const series = years.map(year => {
          const yearData = Array(12).fill(0); // Inicializar array para los 12 meses
          
          requests.forEach(r => {
            const date = new Date(r.fechasolicitud);
            if (date.getFullYear() === year) {
              const month = date.getMonth(); // 0-11
              yearData[month]++;
            }
          });
          
          return {
            name: year.toString(),
            data: yearData
          };
        });
        
        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        charts.yearlyChart = new ApexCharts(document.getElementById('yearlyChart'), {
          series: series,
          chart: {
            height: 400,
            type: 'line',
            dropShadow: {
              enabled: true,
              color: '#000',
              top: 18,
              left: 7,
              blur: 10,
              opacity: 0.1
            },
            toolbar: {
              show: true
            },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800
            }
          },
          colors: ['#0b63e5', '#10b981', '#8b5cf6', '#f97316'],
          dataLabels: {
            enabled: false,
          },
          stroke: {
            curve: 'smooth',
            width: 3
          },
          grid: {
            borderColor: '#e2e8f0',
            row: {
              colors: ['#f8fafc', 'transparent'],
              opacity: 0.5
            },
          },
          markers: {
            size: 4
          },
          xaxis: {
            categories: months,
            labels: {
              style: {
                colors: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
              }
            }
          },
          yaxis: {
            title: {
              text: 'Solicitudes',
              style: {
                color: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
                fontWeight: 500
              }
            },
            labels: {
              style: {
                colors: '#64748b',
                fontSize: '12px',
                fontFamily: 'Inter, sans-serif',
              },
              formatter: function (value) {
                return Math.round(value);
              }
            }
          },
          legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5
          },
          tooltip: {
            y: {
              formatter: function(value) {
                return value + ' solicitudes';
              }
            }
          }
        });
        
        charts.yearlyChart.render();
      }
      
      // Renderizar gráficos de distribución
      function renderDistributionCharts() {
        // Distribución por terminal
        if (document.getElementById('terminalDistributionChart')) {
          if (charts.terminalDistributionChart) {
            charts.terminalDistributionChart.destroy();
          }
          
          const terminalData = requests.reduce((acc, req) => {
            acc[req.terminal] = (acc[req.terminal] || 0) + 1;
            return acc;
          }, {});
          
          charts.terminalDistributionChart = new ApexCharts(document.getElementById('terminalDistributionChart'), {
            series: Object.values(terminalData),
            chart: {
              type: 'pie',
              height: 300,
              animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800,
                animateGradually: {
                  enabled: true,
                  delay: 150
                },
                dynamicAnimation: {
                  enabled: true,
                  speed: 350
                }
              }
            },
            labels: Object.keys(terminalData),
            colors: ['#0b63e5', '#10b981', '#8b5cf6', '#f97316', '#ef4444'],
            legend: {
              position: 'bottom',
              fontFamily: 'Inter, sans-serif'
            },
            dataLabels: {
              enabled: true,
              formatter: function (val, opts) {
                return opts.w.globals.seriesTotals[opts.seriesIndex];
              }
            },
            tooltip: {
              y: {
                formatter: function(value) {
                  return value + ' solicitudes';
                }
              }
            },
            responsive: [{
              breakpoint: 480,
              options: {
                chart: {
                  height: 300
                },
                legend: {
                  position: 'bottom'
                }
              }
            }]
          });
          
          charts.terminalDistributionChart.render();
        }
        
        // Distribución por motivo
        if (document.getElementById('motivoDistributionChart')) {
          if (charts.motivoDistributionChart) {
            charts.motivoDistributionChart.destroy();
          }
          
          const motivoData = requests.reduce((acc, req) => {
            if (req.motivo) {
              acc[req.motivo] = (acc[req.motivo] || 0) + 1;
            }
            return acc;
          }, {});
          
          const colors = {
            'Choque': '#ef4444',
            'Daño de Terceros': '#f97316',
            'Desgaste': '#0ea5e9',
            'Vandalismo': '#8b5cf6',
            'Error de Grabado': '#ec4899',
            'Otro': '#64748b'
          };
          
          charts.motivoDistributionChart = new ApexCharts(document.getElementById('motivoDistributionChart'), {
            series: Object.values(motivoData),
            chart: {
              type: 'pie',
              height: 300,
              animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800,
                animateGradually: {
                  enabled: true,
                  delay: 150
                },
                dynamicAnimation: {
                  enabled: true,
                  speed: 350
                }
              }
            },
            labels: Object.keys(motivoData),
            colors: Object.keys(motivoData).map(key => colors[key] || '#64748b'),
            legend: {
              position: 'bottom',
              fontFamily: 'Inter, sans-serif'
            },
            dataLabels: {
              enabled: true,
              formatter: function (val, opts) {
                return opts.w.globals.seriesTotals[opts.seriesIndex];
              }
            },
            tooltip: {
              y: {
                formatter: function(value) {
                  return value + ' solicitudes';
                }
              }
            },
            responsive: [{
              breakpoint: 480,
              options: {
                chart: {
                  height: 300
                },
                legend: {
                  position: 'bottom'
                }
              }
            }]
          });
          
          charts.motivoDistributionChart.render();
        }
      }
      
      // Actualizar estadísticas
      function updateEstadisticas() {
        if (!document.getElementById('estadisticasPage')) return;
        
        // Promedio mensual
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;
        
        // Contar solicitudes por mes durante el año actual
        const solicitudesPorMes = {};
        let totalSolicitudesMeses = 0;
        
        for (let i = 1; i <= currentMonth; i++) {
          const solicitudesMes = requests.filter(r => {
            const date = new Date(r.fechasolicitud);
            return date.getFullYear() === currentYear && date.getMonth() + 1 === i;
          }).length;
          
          solicitudesPorMes[i] = solicitudesMes;
          totalSolicitudesMeses += solicitudesMes;
        }
        
        const promedioMensual = (totalSolicitudesMeses / currentMonth).toFixed(1);
        document.getElementById('promedioMensual').textContent = promedioMensual;
        
        // Tasa de finalización
        const completados = requests.filter(r => r.estado === 'TERMINADO').length;
        const tasaFinalizacion = requests.length > 0 ? ((completados / requests.length) * 100).toFixed(1) : '0';
        document.getElementById('tasaFinalizacion').textContent = `${tasaFinalizacion}%`;
        
        // Tiempo promedio
        let tiemposTotales = 0;
        let solicitudesConTiempo = 0;
        
        requests.forEach(r => {
          if (r.estado === 'TERMINADO' && r.fechasolicitud && r.fechaactualizacion) {
            const fechaInicio = new Date(r.fechasolicitud);
            const fechaFin = new Date(r.fechaactualizacion);
            const tiempoDias = Math.round((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24));
            
            tiemposTotales += tiempoDias;
            solicitudesConTiempo++;
          }
        });
        
        const tiempoPromedio = solicitudesConTiempo > 0 ? Math.round(tiemposTotales / solicitudesConTiempo) : 0;
        document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} días`;
        
        // Terminal más activo
        const solicitudesPorTerminal = requests.reduce((acc, req) => {
          acc[req.terminal] = (acc[req.terminal] || 0) + 1;
          return acc;
        }, {});
        
        let terminalMasActivo = '';
        let mayorCantidad = 0;
        
        for (const terminal in solicitudesPorTerminal) {
          if (solicitudesPorTerminal[terminal] > mayorCantidad) {
            terminalMasActivo = terminal;
            mayorCantidad = solicitudesPorTerminal[terminal];
          }
        }
        
        document.getElementById('terminalActivo').textContent = terminalMasActivo || '-';
        
        // Gráficos de estadísticas
        renderEstadisticasCharts();
        
        // Estadísticas por terminal
        updateTerminalStats();
      }
      
      // Renderizar gráficos de estadísticas
      function renderEstadisticasCharts() {
        // Tendencia anual
        if (document.getElementById('tendenciaAnualChart')) {
          if (charts.tendenciaAnualChart) {
            charts.tendenciaAnualChart.destroy();
          }
          
          const currentYear = new Date().getFullYear();
          const lastYear = currentYear - 1;
          
          // Datos para este año y el anterior
          const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
          const dataCurrentYear = Array(12).fill(0);
          const dataLastYear = Array(12).fill(0);
          
          requests.forEach(r => {
            const date = new Date(r.fechasolicitud);
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-11
            
            if (year === currentYear) {
              dataCurrentYear[month]++;
            } else if (year === lastYear) {
              dataLastYear[month]++;
            }
          });
          
          charts.tendenciaAnualChart = new ApexCharts(document.getElementById('tendenciaAnualChart'), {
            series: [
              {
                name: lastYear.toString(),
                data: dataLastYear
              },
              {
                name: currentYear.toString(),
                data: dataCurrentYear
              }
            ],
            chart: {
              height: 350,
              type: 'line',
              dropShadow: {
                enabled: true,
                color: '#000',
                top: 18,
                left: 7,
                blur: 10,
                opacity: 0.1
              },
              toolbar: {
                show: true
              },
              animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
              }
            },
            colors: ['#64748b', '#0b63e5'],
            dataLabels: {
              enabled: false,
            },
            stroke: {
              curve: 'smooth',
              width: [3, 4]
            },
            grid: {
              borderColor: '#e2e8f0',
              row: {
                colors: ['#f8fafc', 'transparent'],
                opacity: 0.5
              },
            },
            markers: {
              size: 4
            },
            xaxis: {
              categories: months,
              labels: {
                style: {
                  colors: '#64748b',
                  fontSize: '12px',
                  fontFamily: 'Inter, sans-serif',
                }
              }
            },
            yaxis: {
              title: {
                text: 'Solicitudes',
                style: {
                  color: '#64748b',
                  fontSize: '12px',
                  fontFamily: 'Inter, sans-serif',
                  fontWeight: 500
                }
              },
              labels: {
                style: {
                  colors: '#64748b',
                  fontSize: '12px',
                  fontFamily: 'Inter, sans-serif',
                },
                formatter: function (value) {
                  return Math.round(value);
                }
              }
            },
            legend: {
              position: 'top',
              horizontalAlign: 'right',
              floating: true,
              offsetY: -25,
              offsetX: -5
            },
            tooltip: {
              y: {
                formatter: function(value) {
                  return value + ' solicitudes';
                }
              }
            }
          });
          
          charts.tendenciaAnualChart.render();
        }
        
        // Comparativa mensual
        if (document.getElementById('comparativaMensualChart')) {
          if (charts.comparativaMensualChart) {
            charts.comparativaMensualChart.destroy();
          }
          
          // Datos mensuales para los últimos 6 meses
          const today = new Date();
          const labels = [];
          const pendientes = [];
          const trabajando = [];
          const terminados = [];
          
          for (let i = 5; i >= 0; i--) {
            const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const monthYear = `${month.toLocaleString('es-ES', { month: 'short' })} ${month.getFullYear()}`;
            labels.push(monthYear);
            
            const monthRequests = requests.filter(r => {
              const date = new Date(r.fechasolicitud);
              return date.getMonth() === month.getMonth() && date.getFullYear() === month.getFullYear();
            });
            
            pendientes.push(monthRequests.filter(r => r.estado === 'SOLICITUD').length);
            trabajando.push(monthRequests.filter(r => r.estado === 'TRABAJANDO').length);
            terminados.push(monthRequests.filter(r => r.estado === 'TERMINADO').length);
          }
          
          charts.comparativaMensualChart = new ApexCharts(document.getElementById('comparativaMensualChart'), {
            series: [
              {
                name: 'Pendientes',
                data: pendientes
              },
              {
                name: 'En Proceso',
                data: trabajando
              },
              {
                name: 'Completados',
                data: terminados
              }
            ],
            chart: {
              type: 'bar',
              height: 350,
              stacked: true,
              toolbar: {
                show: true
              },
              animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
              }
            },
            plotOptions: {
              bar: {
                horizontal: false,
                columnWidth: '55%',
                endingShape: 'rounded',
                borderRadius: 4
              },
            },
            dataLabels: {
              enabled: false
            },
            colors: ['#f59e0b', '#0b63e5', '#10b981'],
            stroke: {
              show: true,
              width: 2,
              colors: ['transparent']
            },
            xaxis: {
              categories: labels,
              labels: {
                style: {
                  colors: '#64748b',
                  fontSize: '12px',
                  fontFamily: 'Inter, sans-serif',
                }
              }
            },
            yaxis: {
              title: {
                text: 'Solicitudes',
                style: {
                  color: '#64748b',
                  fontSize: '12px',
                  fontFamily: 'Inter, sans-serif',
                  fontWeight: 500
                }
              },
              labels: {
                style: {
                  colors: '#64748b',
                  fontSize: '12px',
                  fontFamily: 'Inter, sans-serif',
                },
                formatter: function (value) {
                  return Math.round(value);
                }
              }
            },
            fill: {
              opacity: 1
            },
            legend: {
              position: 'top',
              horizontalAlign: 'right'
            },
            tooltip: {
              y: {
                formatter: function (val) {
                  return val + " solicitudes";
                }
              }
            }
          });
          
          charts.comparativaMensualChart.render();
        }
      }
      
      // Actualizar estadísticas por terminal
      function updateTerminalStats() {
        const terminals = ['El Roble', 'La Reina', 'Maria Angelica'];
        
        terminals.forEach(terminal => {
          const terminalRequests = requests.filter(r => r.terminal === terminal);
          const elementId = terminal.replace(/\s+/g, '').toLowerCase();
          
          // Actualizar badge
          if (document.getElementById(`${elementId}Badge`)) {
            document.getElementById(`${elementId}Badge`).textContent = `${terminalRequests.length} solicitudes`;
          }
          
          // Renderizar gráfico
          if (document.getElementById(`${elementId}Chart`)) {
            if (charts[`${elementId}Chart`]) {
              charts[`${elementId}Chart`].destroy();
            }
            
            const pendientes = terminalRequests.filter(r => r.estado === 'SOLICITUD').length;
            const trabajando = terminalRequests.filter(r => r.estado === 'TRABAJANDO').length;
            const terminados = terminalRequests.filter(r => r.estado === 'TERMINADO').length;
            
            charts[`${elementId}Chart`] = new ApexCharts(document.getElementById(`${elementId}Chart`), {
              series: [pendientes, trabajando, terminados],
              chart: {
                height: 200,
                type: 'donut',
                animations: {
                  enabled: true,
                  speed: 500
                }
              },
              labels: ['Pendientes', 'En Proceso', 'Completados'],
              colors: ['#f59e0b', '#0b63e5', '#10b981'],
              legend: {
                position: 'bottom',
                fontFamily: 'Inter, sans-serif',
                fontSize: '12px',
                itemMargin: {
                  horizontal: 5,
                  vertical: 0
                }
              },
              dataLabels: {
                enabled: false
              },
              plotOptions: {
                pie: {
                  donut: {
                    size: '65%'
                  }
                }
              },
              tooltip: {
                y: {
                  formatter: function(value) {
                    return value + ' solicitudes';
                  }
                }
              }
            });
            
            charts[`${elementId}Chart`].render();
          }
        });
      }
      
      // Navegación entre páginas
      function navigateTo(pageId) {
        // Actualizar páginas
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId + 'Page').classList.add('active');
        
        // Actualizar título
        const pageTitle = document.getElementById('pageTitle');
        switch (pageId) {
          case 'dashboard':
            pageTitle.textContent = 'Dashboard';
            break;
          case 'solicitudes':
            pageTitle.textContent = 'Gestión de Solicitudes';
            break;
          case 'nueva-solicitud':
            pageTitle.textContent = 'Nueva Solicitud de Grabado';
            break;
          case 'flota':
            pageTitle.textContent = 'Flota de Vehículos';
            break;
          case 'informes':
            pageTitle.textContent = 'Informes';
            break;
          case 'estadisticas':
            pageTitle.textContent = 'Estadísticas';
            break;
          default:
            pageTitle.textContent = 'Dashboard';
        }
        
        // Animación de entrada
        const elements = document.querySelectorAll(`#${pageId}Page .card, #${pageId}Page .stat-card, #${pageId}Page .vehicle-card, #${pageId}Page .filter-card, #${pageId}Page .report-card, #${pageId}Page .evaluation-card`);
        
        gsap.fromTo(elements, 
          { y: 20, opacity: 0 }, 
          { y: 0, opacity: 1, duration: 0.5, stagger: 0.05, ease: "power1.out" }
        );
        
        // Actualizar datos específicos de la página si es necesario
        if (pageId === 'estadisticas') {
          setTimeout(() => {
            updateEstadisticas();
          }, 100);
        } else if (pageId === 'informes') {
          setTimeout(() => {
            updateReportCounts();
          }, 100);
        }
      }
      
      // Toggle del sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
        
        // Cambiar ícono
        const icon = document.querySelector('#sidebarToggle i');
        if (sidebar.classList.contains('collapsed')) {
          icon.className = 'fas fa-chevron-right';
        } else {
          icon.className = 'fas fa-chevron-left';
        }
      }
      
      // Manejar input de PPU
      function handlePpuInput(e) {
        const query = e.target.value.toUpperCase();
        e.target.value = query;
        
        const numeroInternoInput = document.getElementById('numeroInternoInput');
        const terminalInput = document.getElementById('terminalInput');
        const sugerenciasContainer = document.getElementById('sugerenciasPpu');
        
        sugerenciasContainer.innerHTML = '';
        
        if (!query) {
          numeroInternoInput.value = '';
          return;
        }
        
        const vehicle = vehicles.find(v => v.ppu === query || v.interno === query);
        
        if (vehicle) {
          e.target.value = vehicle.ppu;
          numeroInternoInput.value = vehicle.interno;
          terminalInput.value = vehicle.terminal;
          
          // Animación para indicar autocompletado exitoso
          gsap.fromTo(numeroInternoInput, 
            { backgroundColor: 'rgba(16, 185, 129, 0.1)' },
            { backgroundColor: 'var(--surface-2)', duration: 1 }
          );
        } else {
          numeroInternoInput.value = '';
          
          if (query.length > 1) {
            const sugerencias = vehicles.filter(v => 
              (v.ppu && v.ppu.includes(query)) || 
              (v.interno && v.interno.includes(query))
            ).slice(0, 5);
            
            if(sugerencias.length > 0) {
              const suggestionsBox = document.createElement('div');
              suggestionsBox.className = 'bg-white border rounded-md shadow-lg overflow-hidden';
              
              sugerencias.forEach((v, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 transition-colors';
                
                if (index === sugerencias.length - 1) {
                  div.classList.remove('border-b');
                }
                
                div.innerHTML = `
                  <div class="font-medium">${v.ppu}</div>
                  <div class="text-sm text-gray-500">N° ${v.interno} - ${v.terminal}</div>
                `;
                
                div.onclick = () => {
                  e.target.value = v.ppu;
                  numeroInternoInput.value = v.interno;
                  terminalInput.value = v.terminal;
                  sugerenciasContainer.innerHTML = '';
                  
                  // Animación para indicar selección exitosa
                  gsap.fromTo(e.target, 
                    { borderColor: 'var(--primary)' },
                    { borderColor: 'var(--border)', duration: 1 }
                  );
                };
                
                suggestionsBox.appendChild(div);
              });
              
              sugerenciasContainer.appendChild(suggestionsBox);
              
              // Animación para mostrar sugerencias
              gsap.fromTo(suggestionsBox,
                { y: -10, opacity: 0 },
                { y: 0, opacity: 1, duration: 0.3 }
              );
            }
          }
        }
      }
      
      // Renderizar checkboxes de vidrios
      function renderVidriosCheckboxes() {
        const container = document.getElementById('vidriosContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        VIDRIOS_DISPONIBLES.forEach(vidrio => {
          const id = `vidrio-${vidrio.replace(/\s+/g, '-')}`;
          const fotoId = `foto-${vidrio.replace(/\s+/g, '-')}`;
          
          const vidrioCard = document.createElement('div');
          vidrioCard.className = 'vidrio-card';
          
          vidrioCard.innerHTML = `
            <div class="vidrio-header">
              <label class="vidrio-checkbox">
                <input type="checkbox" id="${id}" name="vidrios" value="${vidrio}">
                <span class="checkmark"></span>
              </label>
              <span class="vidrio-label">${vidrio}</span>
            </div>
            <div class="vidrio-upload">
              <label for="${fotoId}" class="upload-btn">
                <i class="fas fa-camera"></i>
                <span>Adjuntar Foto</span>
              </label>
              <input type="file" id="${fotoId}" accept="image/*" style="display: none;">
              <div class="file-info" id="filename-${fotoId}"></div>
            </div>
          `;
          
          container.appendChild(vidrioCard);
          
          // Event listeners
          document.getElementById(fotoId).addEventListener('change', (e) => {
            const fileName = e.target.files.length > 0 ? e.target.files[0].name : '';
            const fileInfo = document.getElementById(`filename-${fotoId}`);
            
            if (fileName) {
              fileInfo.innerHTML = `<i class="fas fa-file-image"></i> ${fileName}`;
              
              // Animación para indicar archivo seleccionado
              gsap.fromTo(fileInfo,
                { opacity: 0, y: -5 },
                { opacity: 1, y: 0, duration: 0.3 }
              );
            } else {
              fileInfo.innerHTML = '';
            }
          });
        });
      }
      
      // Guardar nueva solicitud
      async function guardarNuevaSolicitud(e) {
        e.preventDefault();
        
        const ppu = document.getElementById('ppuInput').value;
        const vidriosSeleccionados = Array.from(document.querySelectorAll('input[name="vidrios"]:checked')).map(el => el.value);
        
        if (vidriosSeleccionados.length === 0) {
          document.getElementById('vidriosError').style.display = 'block';
          
          // Animación para resaltar el error
          gsap.fromTo('#vidriosError',
            { opacity: 0, y: -10 },
            { opacity: 1, y: 0, duration: 0.3 }
          );
          
          return;
        }
        
        document.getElementById('vidriosError').style.display = 'none';
        showLoader('Subiendo imágenes y guardando solicitud...');
        
        const uploadPromises = vidriosSeleccionados.map(vidrio => {
          const fileInput = document.getElementById(`foto-${vidrio.replace(/\s+/g, '-')}`);
          
          if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = `${ppu}_${vidrio.replace(/\s+/g, '_')}_${Date.now()}.${file.name.split('.').pop()}`;
            return supabase.storage.from('vidrios').upload(fileName, file);
          }
          
          return Promise.resolve(null);
        });
  
        try {
          const uploadResults = await Promise.all(uploadPromises);
          const fotos = [];
          
          for (let i = 0; i < uploadResults.length; i++) {
            if (uploadResults[i] && uploadResults[i].data) {
              const { data: { publicUrl } } = supabase.storage.from('vidrios').getPublicUrl(uploadResults[i].data.path);
              fotos.push({ tipo: vidriosSeleccionados[i], url: publicUrl });
            }
          }
          
          const newRequest = {
            ppu,
            numerointerno: document.getElementById('numeroInternoInput').value,
            terminal: document.getElementById('terminalInput').value,
            fechasolicitud: document.getElementById('fechaSolicitudInput').value,
            fechaprogramacion: document.getElementById('fechaProgramacionInput').value,
            vidrios: vidriosSeleccionados,
            estado: 'SOLICITUD',
            motivo: document.getElementById('motivoInput').value,
            observaciones: document.getElementById('observacionesInput').value,
            fotos,
            fechacreacion: new Date().toISOString(),
          };
          
          if (!newRequest.ppu || !newRequest.numerointerno || !newRequest.terminal || !newRequest.fechasolicitud || !newRequest.fechaprogramacion || !newRequest.motivo) {
            hideLoader();
            showToast('Error', 'Complete todos los campos obligatorios.', 'error');
            return;
          }
          
          const { data, error } = await supabase.from('requests').insert(newRequest).select().single();
          
          if (error) throw error;
          
          requests.unshift(data);
          updateUI();
          hideLoader();
          showToast('Éxito', `Solicitud para PPU ${data.ppu} creada correctamente.`, 'success');
          
          resetForm();
          navigateTo('solicitudes');
        } catch (error) {
          console.error('Error al guardar la solicitud:', error);
          hideLoader();
          showToast('Error', `No se pudo guardar: ${error.message}`, 'error');
        }
      }
      
      // Abrir modal para editar solicitud
      function abrirModalEditar(id) {
        const request = requests.find(r => r.id === id);
        
        if (!request) {
          showToast('Error', 'No se encontró la solicitud.', 'error');
          return;
        }
        
        currentRequestId = id;
        
        document.getElementById('editRequestId').value = id;
        document.getElementById('editModalInfo').innerHTML = `
          <div>PPU: ${request.ppu}</div>
          <div>N° Interno: ${request.numerointerno} - ${request.terminal}</div>
        `;
        document.getElementById('editStatusSelect').value = request.estado;
        
        if (request.fechaprogramacion) {
          document.getElementById('editProgramacionInput').value = request.fechaprogramacion;
        } else {
          // Por defecto, programación para 3 días después
          const threeDaysLater = new Date();
          threeDaysLater.setDate(threeDaysLater.getDate() + 3);
          document.getElementById('editProgramacionInput').value = threeDaysLater.toISOString().split('T')[0];
        }
        
        // Mostrar/ocultar sección de evaluación
        const evaluacionContainer = document.getElementById('evaluacionContainer');
        if (request.estado === 'TERMINADO') {
          evaluacionContainer.style.display = 'block';
          
          // Si ya hay evaluación, cargar datos
          if (request.evaluacion) {
            const evaluacion = request.evaluacion;
            
            // Marcar las valoraciones
            document.querySelectorAll('.evaluation-rating').forEach((rating, index) => {
              const value = evaluacion.valoraciones[index];
              if (value) {
                const option = rating.querySelector(`.rating-option[data-value="${value}"]`);
                if (option) {
                  option.classList.add('selected');
                }
              }
            });
            
            // Cargar observaciones
            document.getElementById('evaluacionObservaciones').value = evaluacion.observaciones || '';
          } else {
            // Limpiar evaluación
            document.querySelectorAll('.rating-option.selected').forEach(option => {
              option.classList.remove('selected');
            });
            document.getElementById('evaluacionObservaciones').value = '';
          }
        } else {
          evaluacionContainer.style.display = 'none';
        }
        
        document.getElementById('editModal').classList.add('active');
        
        // Animación del modal
        const modalContainer = document.querySelector('#editModal .modal-container');
        gsap.fromTo(modalContainer,
          { scale: 0.9, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
        );
      }
      
      async function guardarCambiosSolicitud() {
  const id = parseInt(document.getElementById('editRequestId').value);
  const newStatus = document.getElementById('editStatusSelect').value;
  const newProgramacion = document.getElementById('editProgramacionInput').value;
  
  showLoader('Actualizando solicitud...');
  
  // Datos base a actualizar - QUITANDO calidad y evaluacion
  const updateData = {
    estado: newStatus,
    fechaprogramacion: newProgramacion,
    fechaactualizacion: new Date().toISOString()
  };
  
  
  try {
    const { data, error } = await supabase.from('requests')
      .update(updateData)
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    
    const index = requests.findIndex(r => r.id === id);
    if (index !== -1) requests[index] = data;
    
    updateUI();
    hideLoader();
    closeModal('editModal');
    showToast('Éxito', 'La solicitud ha sido actualizada correctamente.', 'success');
  } catch (error) {
    hideLoader();
    showToast('Error', `No se pudo actualizar: ${error.message}`, 'error');
  }
}
      
      // Mostrar historial de vehículo
      function mostrarHistorialVehiculo(ppu) {
        const vehicle = vehicles.find(v => v.ppu === ppu);
        
        if (!vehicle) {
          showToast('Error', 'No se encontró el vehículo.', 'error');
          return;
        }
        
        const vehicleRequests = requests
          .filter(r => r.ppu === ppu)
          .sort((a, b) => new Date(b.fechasolicitud) - new Date(a.fechasolicitud));
        
        // Información del vehículo
        document.getElementById('vehiclePPU').textContent = vehicle.ppu;
        document.getElementById('vehicleInfo').textContent = `Información del vehículo`;
        document.getElementById('vehicleInterno').textContent = vehicle.interno;
        document.getElementById('vehicleTerminal').textContent = vehicle.terminal;
        document.getElementById('vehicleTotalRequests').textContent = vehicleRequests.length;
        document.getElementById('vehicleLastRequest').textContent = vehicleRequests.length > 0 ? formatDate(vehicleRequests[0].fechasolicitud) : 'Ninguna';
        
        // Limpiar timeline y contenido
        const timelineContainer = document.getElementById('historyTimeline');
        timelineContainer.innerHTML = '';
        
        document.getElementById('historyContent').innerHTML = `
          <div id="noContentMessage" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-light); padding: 2rem;">
            <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary-light);"></i>
            <p>Selecciona una solicitud del historial para ver los detalles</p>
          </div>
        `;
        
        if (vehicleRequests.length === 0) {
          timelineContainer.innerHTML = `
            <div style="text-align: center; padding: 2rem 0; color: var(--text-light);">
              No hay solicitudes registradas para este vehículo.
            </div>
          `;
        } else {
          const timeline = document.createElement('div');
          timeline.className = 'timeline';
          
          vehicleRequests.forEach((req, index) => {
            // Determinar ícono según estado
            let badgeIcon = 'fa-clock';
            let badgeClass = 'primary';
            
            if (req.estado === 'TERMINADO') {
              badgeIcon = 'fa-check';
              badgeClass = 'success';
            } else if (req.estado === 'TRABAJANDO') {
              badgeIcon = 'fa-tools';
              badgeClass = 'warning';
            }
            
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            timelineItem.dataset.requestId = req.id;
            
            timelineItem.innerHTML = `
              <div class="timeline-badge ${badgeClass}">
                <i class="fas ${badgeIcon}"></i>
              </div>
              <div class="timeline-content" onclick="showRequestDetail(${req.id})">
                <div class="timeline-header">
                  <div class="timeline-title">${req.motivo || 'Sin motivo'}</div>
                  <div class="timeline-date">${formatDate(req.fechasolicitud)}</div>
                </div>
                <div class="timeline-body">
                  <span class="badge ${getStatusBadgeClass(req.estado)}"><i class="${getStatusIcon(req.estado)}"></i> ${req.estado}</span>
                  <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-light);">
                    ${req.vidrios.length} vidrio${req.vidrios.length !== 1 ? 's' : ''} • 
                    ${req.fotos && req.fotos.length ? req.fotos.length + ' foto' + (req.fotos.length !== 1 ? 's' : '') : 'Sin fotos'}
                  </div>
                </div>
              </div>
            `;
            
            timeline.appendChild(timelineItem);
            
            // Mostrar el primer elemento por defecto
            if (index === 0) {
              setTimeout(() => {
                showRequestDetail(req.id);
              }, 300);
            }
          });
          
          timelineContainer.appendChild(timeline);
        }
        
        document.getElementById('historyModal').classList.add('active');
        
        // Animación del modal
        const modalContainer = document.querySelector('#historyModal .modal-container');
        gsap.fromTo(modalContainer,
          { scale: 0.9, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
        );
      }
      
      // Mostrar detalle de solicitud en el historial
      function showRequestDetail(id) {
        const request = requests.find(r => r.id === id);
        
        if (!request) {
          showToast('Error', 'No se encontró la solicitud.', 'error');
          return;
        }
        
        selectedRequest = request;
        
        // Marcar item activo en timeline
        document.querySelectorAll('.timeline-item').forEach(item => {
          item.classList.remove('active');
        });
        
        document.querySelector(`.timeline-item[data-request-id="${id}"]`).classList.add('active');
        
        // Crear contenido
        const content = document.getElementById('historyContent');
        content.innerHTML = '';
        
        const detail = document.createElement('div');
        detail.className = 'vehicle-viewer-detail';
        
        // Encabezado con información general
        detail.innerHTML = `
          <div class="vehicle-viewer-detail-header">
            <div class="vehicle-viewer-detail-title">${request.motivo || 'Sin motivo'}</div>
            <div class="vehicle-viewer-detail-date">${formatDate(request.fechasolicitud)}</div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.25rem;">
            <div>
              <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Estado</div>
              <div><span class="badge ${getStatusBadgeClass(request.estado)}"><i class="${getStatusIcon(request.estado)}"></i> ${request.estado}</span></div>
            </div>
            
            <div>
              <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Terminal</div>
              <div>${request.terminal || '-'}</div>
            </div>
            
            <div>
              <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Fecha de Programación</div>
              <div>${request.fechaprogramacion ? formatDate(request.fechaprogramacion) : 'No programada'}</div>
            </div>
            
            <div>
              <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Última Actualización</div>
              <div>${request.fechaactualizacion ? formatDate(request.fechaactualizacion) : 'Sin actualizar'}</div>
            </div>
          </div>
          
          <div style="margin-bottom: 1.25rem;">
            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Vidrios</div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              ${request.vidrios.map(vidrio => `
                <span class="badge badge-primary" style="background-color: var(--primary-light); color: white;">
                  <i class="fas fa-glass-martini"></i> ${vidrio}
                </span>
              `).join('')}
            </div>
          </div>
        `;
        
        // Mostrar evaluación si está completa
        if (request.estado === 'TERMINADO' && request.evaluacion) {
          const evaluacion = request.evaluacion;
          const criterios = ['Calidad del grabado', 'Precisión de ubicación', 'Acabado final', 'Tiempo de ejecución'];
          
          let evaluacionHTML = `
            <div style="margin-bottom: 1.25rem;">
              <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Evaluación de Calidad</div>
              <div style="background-color: var(--surface-2); border-radius: var(--radius); padding: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 0.75rem;">
        `;
        
        // Agregar criterios de evaluación
        criterios.forEach((criterio, index) => {
          const valor = evaluacion.valoraciones[index] || 0;
          
          evaluacionHTML += `
            <div>
              <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">${criterio}</div>
              <div style="display: flex; gap: 0.25rem;">
                ${generateRatingStars(valor)}
              </div>
            </div>
          `;
        });
        
        // Agregar observaciones
        evaluacionHTML += `
                </div>
                ${evaluacion.observaciones ? `
                <div>
                  <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Observaciones</div>
                  <div style="font-size: 0.9rem; color: var(--text);">${evaluacion.observaciones}</div>
                </div>` : ''}
              </div>
            </div>
        `;
        
        detail.innerHTML += evaluacionHTML;
      }
      
      // Observaciones
      if (request.observaciones) {
        detail.innerHTML += `
          <div style="margin-bottom: 1.25rem;">
            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;">Observaciones</div>
            <div style="background-color: var(--surface-2); border-radius: var(--radius); padding: 1rem; font-size: 0.9rem;">
              ${request.observaciones}
            </div>
          </div>
        `;
      }
      
      // Galería de fotos
      if (request.fotos && request.fotos.length > 0) {
        let galeriaHTML = `
          <div style="margin-top: 1.5rem;">
            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem;">Fotografías (${request.fotos.length})</div>
            <div class="vehicle-viewer-gallery">
        `;
        
        request.fotos.forEach(foto => {
          galeriaHTML += `
            <div class="vehicle-viewer-gallery-item" onclick="showFullSizeImage('${foto.url}', '${foto.tipo}')">
              <img src="${foto.url}" alt="${foto.tipo}">
              <div class="vehicle-viewer-gallery-item-caption">${foto.tipo}</div>
            </div>
          `;
        });
        
        galeriaHTML += `
            </div>
          </div>
        `;
        
        detail.innerHTML += galeriaHTML;
      } else {
        detail.innerHTML += `
          <div style="margin-top: 1.5rem; text-align: center; padding: 2rem; color: var(--text-light); background-color: var(--surface-2); border-radius: var(--radius);">
            <i class="fas fa-image" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
            <p>No hay fotografías disponibles</p>
          </div>
        `;
      }
      
      content.appendChild(detail);
      
      // Ocultar mensaje de "sin contenido"
      document.getElementById('noContentMessage').style.display = 'none';
      
      // Animar contenido
      gsap.fromTo(detail, 
        { opacity: 0, y: 20 }, 
        { opacity: 1, y: 0, duration: 0.4, ease: "power2.out" }
      );
    }
    
    function showFullSizeImage(url, title) {
  // Obtener referencias
  const modal = document.getElementById('imageViewerModal');
  const imgElement = document.getElementById('fullSizeImage');
  
  // Siempre comenzar con la imagen oculta
  imgElement.style.display = 'none';
  
  // Mostrar el modal
  modal.classList.add('active');
  
  // Establecer el título
  document.getElementById('imageTitle').textContent = title;
  
  // Crear una nueva imagen para precargar
  const newImg = new Image();
  
  // Cuando la imagen cargue, mostrarla
  newImg.onload = function() {
    // Primero establecer la fuente
    imgElement.src = url;
    // Luego mostrarla
    imgElement.style.display = 'block';
  };
  
  // Manejar errores
  newImg.onerror = function() {
    console.error('Error al cargar la imagen:', url);
    document.getElementById('imageTitle').textContent = 'Error al cargar la imagen';
  };
  
  // Iniciar la carga
  newImg.src = url;
}

    
    // Confirmar eliminación de solicitud
    function confirmarEliminarSolicitud(id) {
      document.getElementById('deleteRequestId').value = id;
      document.getElementById('deleteConfirmModal').classList.add('active');
      
      // Animación del modal
      const modalContainer = document.querySelector('#deleteConfirmModal .modal-container');
      gsap.fromTo(modalContainer,
        { scale: 0.9, opacity: 0 },
        { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
      );
    }
    
    // Eliminar solicitud
    async function eliminarSolicitud() {
      const id = parseInt(document.getElementById('deleteRequestId').value);
      
      showLoader('Eliminando solicitud...');
      
      try {
        const { error } = await supabase.from('requests')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        // Actualizar arreglo local
        const index = requests.findIndex(r => r.id === id);
        if (index !== -1) {
          requests.splice(index, 1);
        }
        
        updateUI();
        hideLoader();
        closeModal('deleteConfirmModal');
        showToast('Éxito', 'La solicitud ha sido eliminada correctamente.', 'success');
      } catch (error) {
        hideLoader();
        showToast('Error', `No se pudo eliminar: ${error.message}`, 'error');
      }
    }
    
    // Resetear formulario
    function resetForm() {
      document.getElementById('nuevaSolicitudForm').reset();
      document.getElementById('numeroInternoInput').value = '';
      document.getElementById('vidriosError').style.display = 'none';
      
      // Limpiar archivos seleccionados
      document.querySelectorAll('[id^="filename-foto-"]').forEach(el => {
        el.innerHTML = '';
      });
      
      // Inicializar fechas
      initDatePickers();
      
      // Renderizar checkboxes de vidrios
      renderVidriosCheckboxes();
    }
    
    // Resetear filtros
    function resetFilters() {
      document.getElementById('filterPpu').value = '';
      document.getElementById('filterTerminal').value = '';
      document.getElementById('filterEstado').value = '';
      document.getElementById('filterMotivo').value = '';
      document.getElementById('filterFechaDesde').value = '';
      document.getElementById('filterFechaHasta').value = '';
      
      // Recargar datos
      loadSolicitudesData();
      
      showToast('Filtros', 'Los filtros han sido restablecidos.', 'info');
    }
    
    // Generar estrellas para calificación
    function generateRatingStars(value) {
      let starsHTML = '';
      
      for (let i = 1; i <= 5; i++) {
        if (i <= value) {
          starsHTML += `<i class="fas fa-star" style="color: var(--primary);"></i>`;
        } else {
          starsHTML += `<i class="far fa-star" style="color: var(--text-lighter);"></i>`;
        }
      }
      
      return starsHTML;
    }
    
    // Generar informe de solicitudes pendientes
    function generarInformePendientes() {
      const pendientes = requests.filter(r => r.estado !== 'TERMINADO');
      
      if (pendientes.length === 0) {
        showToast('Información', 'No hay solicitudes pendientes para generar el informe.', 'info');
        return;
      }
      
      exportToExcel(pendientes, 'Solicitudes_Pendientes');
    }
    
    // Generar informe de solicitudes realizadas
    function generarInformeRealizados() {
      const realizados = requests.filter(r => r.estado === 'TERMINADO');
      
      if (realizados.length === 0) {
        showToast('Información', 'No hay solicitudes completadas para generar el informe.', 'info');
        return;
      }
      
      exportToExcel(realizados, 'Solicitudes_Realizadas');
    }
    
    // Generar informe mensual
    function generarInformeMensual() {
      const selectedMonth = parseInt(document.getElementById('mesMensual').value);
      const currentYear = new Date().getFullYear();
      
      const mensuales = requests.filter(r => {
        const date = new Date(r.fechasolicitud);
        return date.getMonth() + 1 === selectedMonth && date.getFullYear() === currentYear;
      });
      
      if (mensuales.length === 0) {
        showToast('Información', 'No hay solicitudes en el mes seleccionado para generar el informe.', 'info');
        return;
      }
      
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      exportToExcel(mensuales, `Informe_${monthNames[selectedMonth - 1]}_${currentYear}`);
    }
    
    // Generar informe anual
    function generarInformeAnual() {
      const selectedYear = parseInt(document.getElementById('anioAnual').value);
      
      const anuales = requests.filter(r => {
        const date = new Date(r.fechasolicitud);
        return date.getFullYear() === selectedYear;
      });
      
      if (anuales.length === 0) {
        showToast('Información', 'No hay solicitudes en el año seleccionado para generar el informe.', 'info');
        return;
      }
      
      exportToExcel(anuales, `Informe_Anual_${selectedYear}`);
    }
    
    // Exportar solicitudes a Excel
    function exportSolicitudesToExcel() {
      // Filtrar solicitudes según filtros actuales
      const filterPpu = document.getElementById('filterPpu')?.value.toUpperCase() || '';
      const filterTerminal = document.getElementById('filterTerminal')?.value || '';
      const filterEstado = document.getElementById('filterEstado')?.value || '';
      const filterMotivo = document.getElementById('filterMotivo')?.value || '';
      const filterFechaDesde = document.getElementById('filterFechaDesde')?.value || '';
      const filterFechaHasta = document.getElementById('filterFechaHasta')?.value || '';
      
      let filteredRequests = [...requests];
      
      if (filterPpu) {
        filteredRequests = filteredRequests.filter(req => 
          (req.ppu && req.ppu.includes(filterPpu)) || 
          (req.numerointerno && req.numerointerno.includes(filterPpu))
        );
      }
      
      if (filterTerminal) {
        filteredRequests = filteredRequests.filter(req => req.terminal === filterTerminal);
      }
      
      if (filterEstado) {
        filteredRequests = filteredRequests.filter(req => req.estado === filterEstado);
      }
      
      if (filterMotivo) {
        filteredRequests = filteredRequests.filter(req => req.motivo === filterMotivo);
      }
      
      if (filterFechaDesde) {
        filteredRequests = filteredRequests.filter(req => req.fechasolicitud >= filterFechaDesde);
      }
      
      if (filterFechaHasta) {
        filteredRequests = filteredRequests.filter(req => req.fechasolicitud <= filterFechaHasta);
      }
      
      if (filteredRequests.length === 0) {
        showToast('Información', 'No hay datos para exportar con los filtros actuales.', 'info');
        return;
      }
      
      exportToExcel(filteredRequests, 'Solicitudes_GrabaVidrios');
    }
    
    // Función genérica para exportar a Excel
    function exportToExcel(data, fileName) {
      try {
        showLoader('Generando informe...');
        
        // Preparar datos para Excel
        const exportData = data.map(req => ({
          PPU: req.ppu,
          'N° Interno': req.numerointerno || '',
          Terminal: req.terminal || '',
          'Fecha Solicitud': formatDate(req.fechasolicitud),
          'Fecha Programación': req.fechaprogramacion ? formatDate(req.fechaprogramacion) : '',
          'Motivo': req.motivo || '',
          'Vidrios': req.vidrios ? req.vidrios.join(', ') : '',
          'Estado': req.estado,
          'Calidad': req.calidad ? req.calidad.toFixed(1) + '/5' : '-',
          'Observaciones': req.observaciones || ''
        }));
        
        // Crear hoja de cálculo
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Solicitudes');
        
        // Establecer anchos de columna
        const colWidths = [
          { wch: 10 }, // PPU
          { wch: 12 }, // N° Interno
          { wch: 15 }, // Terminal
          { wch: 15 }, // Fecha Solicitud
          { wch: 15 }, // Fecha Programación
          { wch: 20 }, // Motivo
          { wch: 30 }, // Vidrios
          { wch: 12 }, // Estado
          { wch: 10 }, // Calidad
          { wch: 40 }  // Observaciones
        ];
        ws['!cols'] = colWidths;
        
        // Guardar archivo
        const fileNameWithDate = `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileNameWithDate);
        
        hideLoader();
        showToast('Éxito', 'El informe ha sido generado correctamente.', 'success');
      } catch (error) {
        console.error('Error al exportar a Excel:', error);
        hideLoader();
        showToast('Error', 'No se pudo generar el informe.', 'error');
      }
    }
    
    function closeModal(id) {
  const modal = document.getElementById(id);
  
  // Si es el visor de imágenes, destruir completamente el contenido
  if (id === 'imageViewerModal') {
    const modalContainer = modal.querySelector('.modal-container');
    // Eliminar la imagen anterior y reiniciar completamente
    const imgElement = document.getElementById('fullSizeImage');
    imgElement.removeAttribute('src');
    imgElement.style.display = 'none';
    document.getElementById('imageTitle').textContent = '';
  }
  
  modal.classList.remove('active');
}
    
    // Mostrar/ocultar loader
    function showLoader(message = 'Cargando datos...') {
      const loader = document.getElementById('loader');
      const loaderText = document.querySelector('.loader-text');
      
      loaderText.textContent = message;
      loader.style.display = 'flex';
      
      gsap.fromTo(loader,
        { opacity: 0 },
        { opacity: 1, duration: 0.3 }
      );
    }
    
    function hideLoader() {
      const loader = document.getElementById('loader');
      
      gsap.to(loader, {
        opacity: 0,
        duration: 0.3,
        onComplete: () => {
          loader.style.display = 'none';
        }
      });
    }
    
    // Mostrar toast
    function showToast(title, message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast ${type}`;
      
      const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-times-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
      };
      
      toast.innerHTML = `
        <div class="toast-icon ${type}">
          <i class="fas ${icons[type]}"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <div class="toast-progress"></div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Animación para mostrar el toast
      setTimeout(() => {
        toast.classList.add('active');
      }, 10);
      
      // Eliminar el toast después de 4 segundos
      setTimeout(() => {
        toast.classList.remove('active');
        
        // Eliminar del DOM después de la animación
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 4000);
    }
    
    // Funciones de utilidad
    
    // Obtener clase de badge según estado
    function getStatusBadgeClass(estado) {
      switch (estado) {
        case 'SOLICITUD':
          return 'badge-warning';
        case 'TRABAJANDO':
          return 'badge-primary';
        case 'TERMINADO':
          return 'badge-success';
        default:
          return 'badge-info';
      }
    }
    
    // Obtener ícono según estado
    function getStatusIcon(estado) {
      switch (estado) {
        case 'SOLICITUD':
          return 'fas fa-clock';
        case 'TRABAJANDO':
          return 'fas fa-tools';
        case 'TERMINADO':
          return 'fas fa-check-circle';
        default:
          return 'fas fa-info-circle';
      }
    }
    
    // Obtener estado del vehículo
    function getVehicleStatus(ppu) {
      const vehicleRequests = requests.filter(r => r.ppu === ppu);
      
      if (vehicleRequests.length === 0) {
        return { 
          text: 'Sin Solicitudes', 
          class: 'none', 
          badgeClass: 'badge-info',
          icon: 'fas fa-info-circle'
        };
      }
      
      if (vehicleRequests.some(r => r.estado !== 'TERMINADO')) {
        return { 
          text: 'Pendiente', 
          class: 'pending', 
          badgeClass: 'badge-warning',
          icon: 'fas fa-clock'
        };
      }
      
      return { 
        text: 'Completo', 
        class: 'completed', 
        badgeClass: 'badge-success',
        icon: 'fas fa-check-circle'
      };
    }
    
    // Formatear fecha
    function formatDate(dateString) {
      if (!dateString) return '-';
      
      try {
        return moment(dateString).format('DD/MM/YYYY');
      } catch (error) {
        return '-';
      }
    }
  </script>
</body>
</html>
